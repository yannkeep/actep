<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cellules Citoyennes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,system-ui,sans-serif; background:#0a0a0f; color:#fff; min-height:100vh; }
        
        /* Onboarding */
        #onboarding { position:fixed; inset:0; background:#0a0a0f; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem; text-align:center; }
        #onboarding.hidden { display:none; }
        #onboarding h1 { font-size:1.8rem; color:#00ff9d; margin:1rem 0 0.5rem; }
        #onboarding p { color:#888; max-width:300px; line-height:1.6; margin-bottom:2rem; }
        #onboarding .steps { display:flex; gap:2rem; margin-bottom:2rem; }
        #onboarding .step { text-align:center; }
        #onboarding .step-icon { font-size:2rem; }
        #onboarding .step-text { font-size:0.75rem; color:#666; margin-top:0.3rem; }
        #onboarding input { width:100%; max-width:280px; padding:1rem; background:#111; border:1px solid #333; color:#fff; font-size:1rem; margin-bottom:1rem; text-align:center; }
        #onboarding input:focus { outline:none; border-color:#00ff9d; }
        #onboarding button { background:#00ff9d; color:#000; border:none; padding:1rem 3rem; font-size:1rem; font-weight:600; cursor:pointer; }
        #onboarding button:hover { box-shadow:0 0 30px rgba(0,255,157,0.5); }
        #onboarding .error { color:#ff3366; font-size:0.85rem; margin-top:-0.5rem; margin-bottom:1rem; display:none; }
        
        /* App */
        #app { display:none; height:100vh; }
        #app.active { display:flex; flex-direction:column; }
        
        /* Header */
        header { background:#111; padding:0.75rem 1rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #222; }
        .logo { font-weight:700; color:#00ff9d; }
        .stats { display:flex; gap:1.5rem; }
        .stat-val { font-weight:700; color:#00ff9d; }
        .stat-lbl { font-size:0.6rem; color:#555; }
        .menu-btn { display:none; background:none; border:1px solid #333; color:#fff; padding:0.5rem 0.75rem; cursor:pointer; }
        @media(max-width:768px) { .menu-btn { display:block; } }
        
        /* Main */
        main { flex:1; display:flex; overflow:hidden; }
        
        /* Map */
        #map-wrap { flex:1; position:relative; }
        #map { width:100%; height:100%; background:#000; }
        .leaflet-tile-pane { filter:saturate(0) brightness(0.3) contrast(1.3); }
        
        /* FAB */
        .fab { position:absolute; bottom:1.5rem; right:1rem; z-index:500; width:56px; height:56px; background:#00ff9d; color:#000; border:none; border-radius:50%; font-size:2rem; cursor:pointer; box-shadow:0 4px 20px rgba(0,255,157,0.4); }
        .fab:hover { transform:scale(1.1); }
        
        /* Locate */
        .locate { position:absolute; top:1rem; right:1rem; z-index:500; width:40px; height:40px; background:#111; border:1px solid #333; color:#fff; cursor:pointer; font-size:1.2rem; }
        .locate:hover { border-color:#00ff9d; color:#00ff9d; }
        
        /* Toggle */
        .toggle { position:absolute; bottom:1.5rem; left:1rem; z-index:500; background:#111; border:1px solid #333; color:#888; padding:0.5rem 1rem; font-size:0.75rem; cursor:pointer; }
        .toggle.active { background:#00ff9d; color:#000; border-color:#00ff9d; }
        
        /* Sidebar */
        #sidebar { width:350px; background:#111; border-left:1px solid #222; display:flex; flex-direction:column; }
        @media(max-width:768px) {
            #sidebar { position:fixed; top:0; right:0; bottom:0; width:100%; transform:translateX(100%); transition:transform 0.3s; z-index:1000; }
            #sidebar.open { transform:translateX(0); }
        }
        .sidebar-header { padding:1rem; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center; }
        .sidebar-title { font-weight:600; }
        .sidebar-close { display:none; background:none; border:none; color:#888; font-size:1.5rem; cursor:pointer; }
        @media(max-width:768px) { .sidebar-close { display:block; } }
        .sidebar-body { flex:1; overflow-y:auto; padding:1rem; }
        
        /* Cards */
        .card { background:#0a0a0f; border:1px solid #222; padding:0.75rem; margin-bottom:0.5rem; cursor:pointer; }
        .card:hover { border-color:#00ff9d; }
        .card-title { font-weight:600; font-size:0.9rem; margin-bottom:0.25rem; }
        .card-meta { font-size:0.75rem; color:#666; }
        .badge { font-size:0.6rem; padding:0.2rem 0.5rem; margin-left:0.5rem; }
        .badge-yellow { background:rgba(255,234,0,0.2); color:#ffea00; }
        .badge-green { background:rgba(0,255,157,0.2); color:#00ff9d; }
        .badge-pink { background:rgba(255,0,128,0.2); color:#ff0080; }
        
        /* Progress */
        .progress { height:4px; background:#222; margin-top:0.5rem; }
        .progress-fill { height:100%; background:linear-gradient(90deg,#00ff9d,#00d4ff); }
        
        /* Forms */
        .form-group { margin-bottom:1rem; }
        .form-label { display:block; font-size:0.75rem; color:#888; margin-bottom:0.3rem; }
        .form-input { width:100%; padding:0.75rem; background:#0a0a0f; border:1px solid #222; color:#fff; font-size:0.9rem; }
        .form-input:focus { outline:none; border-color:#00ff9d; }
        select.form-input { cursor:pointer; }
        textarea.form-input { min-height:80px; resize:vertical; font-family:inherit; }
        
        /* Buttons */
        .btn { padding:0.75rem 1.5rem; border:none; font-size:0.85rem; font-weight:600; cursor:pointer; width:100%; }
        .btn-primary { background:#00ff9d; color:#000; }
        .btn-primary:hover { box-shadow:0 0 15px rgba(0,255,157,0.4); }
        .btn-secondary { background:transparent; border:1px solid #333; color:#fff; }
        .btn-back { background:transparent; border:1px solid #333; color:#888; margin-bottom:1rem; }
        .btn-group { display:flex; gap:0.5rem; margin-top:1rem; }
        .btn-group .btn { flex:1; }
        
        /* Detail */
        .detail-title { font-size:1.2rem; font-weight:600; margin-bottom:0.5rem; }
        .detail-meta { font-size:0.8rem; color:#888; margin-bottom:1rem; }
        .detail-desc { font-size:0.85rem; color:#aaa; line-height:1.5; margin-bottom:1rem; }
        .section-title { font-size:0.75rem; color:#00d4ff; font-weight:600; margin:1.5rem 0 0.75rem; }
        .participant { display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid #222; font-size:0.85rem; }
        .participant:last-child { border:none; }
        
        /* Toast */
        #toast { position:fixed; bottom:-60px; left:50%; transform:translateX(-50%); background:#111; border:1px solid #00ff9d; padding:0.75rem 1.5rem; z-index:9999; transition:bottom 0.3s; font-size:0.85rem; }
        #toast.show { bottom:2rem; }
        
        /* Empty */
        .empty { text-align:center; padding:3rem 1rem; color:#444; }
        .empty-icon { font-size:3rem; margin-bottom:1rem; }
    </style>
</head>
<body>
    <!-- ONBOARDING -->
    <div id="onboarding">
        <div style="font-size:4rem;">‚ö°</div>
        <h1>Cellules Citoyennes</h1>
        <p>Cr√©ez des groupes de veille citoyenne et lancez des ateliers d'intelligence collective.</p>
        <div class="steps">
            <div class="step"><div class="step-icon">üìç</div><div class="step-text">Choisissez un lieu</div></div>
            <div class="step"><div class="step-icon">üë•</div><div class="step-text">5 √† 9 personnes</div></div>
            <div class="step"><div class="step-icon">üí¨</div><div class="step-text">Lancez un atelier</div></div>
        </div>
        <input type="text" id="pseudo-input" placeholder="Votre pseudo">
        <div class="error" id="pseudo-error">Entrez un pseudo</div>
        <button onclick="enterApp()">Commencer</button>
    </div>

    <!-- APP -->
    <div id="app">
        <header>
            <div class="logo">‚ö° Cellules</div>
            <div class="stats">
                <div><span class="stat-val" id="stat-c">0</span> <span class="stat-lbl">cellules</span></div>
                <div><span class="stat-val" id="stat-p">0</span> <span class="stat-lbl">citoyens</span></div>
            </div>
            <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        </header>
        <main>
            <div id="map-wrap">
                <div id="map"></div>
                <button class="locate" onclick="locate()">üìç</button>
                <button class="toggle active" id="toggle-links" onclick="toggleLinks()">üîó R√©seau</button>
                <button class="fab" onclick="openCreate()">+</button>
            </div>
            <aside id="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title" id="sidebar-title">Cellules</span>
                    <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
                </div>
                <div class="sidebar-body" id="sidebar-body"></div>
            </aside>
        </main>
    </div>

    <!-- TOAST -->
    <div id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    // === CONFIG ===
    const KEY = 'cellules_v1';
    const THEMES = {
        mobilite: 'üö≤ Mobilit√©',
        environnement: 'üå± Environnement',
        social: 'ü§ù Social',
        numerique: 'üíª Num√©rique',
        culture: 'üé≠ Culture',
        economie: 'üíº √âconomie',
        democratie: 'üó≥Ô∏è D√©mocratie',
        education: 'üìö √âducation',
        sante: 'üè• Sant√©',
        autre: 'üìã Autre'
    };
    
    // Antennes seed
    const SEEDS = [
        { id:'seed1', lat:50.8466, lon:4.3528, title:'Antenne Bruxelles', theme:'democratie', desc:'Point de ralliement Bruxelles-Centre' },
        { id:'seed2', lat:50.4669, lon:4.8675, title:'Antenne Namur', theme:'democratie', desc:'Point de ralliement Namur' },
        { id:'seed3', lat:50.6326, lon:5.5797, title:'Antenne Li√®ge', theme:'social', desc:'Point de ralliement Li√®ge' },
        { id:'seed4', lat:50.4108, lon:4.4446, title:'Antenne Charleroi', theme:'social', desc:'Point de ralliement Charleroi' },
        { id:'seed5', lat:50.4542, lon:3.9523, title:'Antenne Mons', theme:'culture', desc:'Point de ralliement Mons' }
    ];
    
    // === STATE ===
    let map, layerCellules, layerLinks;
    let data = null;
    let user = null;
    let userPos = null;
    let clickedPos = null;
    let showLinks = true;
    
    // === INIT ===
    function boot() {
        user = localStorage.getItem('cellules_user');
        data = loadData();
        
        if (user) {
            startApp();
        }
    }
    
    function loadData() {
        const saved = localStorage.getItem(KEY);
        if (saved) return JSON.parse(saved);
        
        // Init seeds
        const d = {
            cellules: SEEDS.map(s => ({
                ...s,
                seed: true,
                creator: 'R√©seau',
                participants: [{ name: 'R√©seau', role: 'seed' }],
                min: 5, max: 15,
                radius: 10
            })),
            ateliers: []
        };
        localStorage.setItem(KEY, JSON.stringify(d));
        return d;
    }
    
    function saveData() {
        localStorage.setItem(KEY, JSON.stringify(data));
    }
    
    // === ENTER APP ===
    function enterApp() {
        const input = document.getElementById('pseudo-input');
        const error = document.getElementById('pseudo-error');
        const pseudo = input.value.trim();
        
        if (!pseudo) {
            error.style.display = 'block';
            input.focus();
            return;
        }
        
        user = pseudo;
        localStorage.setItem('cellules_user', pseudo);
        startApp();
    }
    
    function startApp() {
        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('app').classList.add('active');
        
        // Wait for Leaflet
        if (typeof L === 'undefined') {
            setTimeout(startApp, 100);
            return;
        }
        
        initMap();
    }
    
    // === MAP ===
    function initMap() {
        map = L.map('map', { center: [50.5, 4.5], zoom: 8, zoomControl: false });
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(map);
        
        layerCellules = L.layerGroup().addTo(map);
        layerLinks = L.layerGroup().addTo(map);
        
        map.on('click', e => {
            clickedPos = { lat: e.latlng.lat, lon: e.latlng.lng };
            openCreate();
        });
        
        render();
        renderList();
        updateStats();
        locate();
    }
    
    function render() {
        layerCellules.clearLayers();
        layerLinks.clearLayers();
        
        // Draw cellules
        data.cellules.forEach(c => {
            const n = c.participants.length;
            const ready = n >= (c.min || 5);
            let color = '#ffea00';
            if (ready) color = '#00ff9d';
            if (c.seed) color = '#ff0080';
            
            const marker = L.circleMarker([c.lat, c.lon], {
                radius: Math.min(18, 7 + n * 1.5),
                color, fillColor: color, fillOpacity: 0.8, weight: 2
            });
            marker.on('click', e => { L.DomEvent.stopPropagation(e); showDetail(c.id); });
            marker.bindTooltip(`<b>${c.title}</b><br>${n} participant${n>1?'s':''}`);
            marker.addTo(layerCellules);
        });
        
        // Draw links
        if (showLinks) {
            const active = data.cellules.filter(c => c.participants.length >= 5);
            active.forEach((a, i) => {
                active.slice(i+1).forEach(b => {
                    const d = dist(a.lat, a.lon, b.lat, b.lon);
                    if (d < 30) {
                        L.polyline([[a.lat, a.lon], [b.lat, b.lon]], {
                            color: '#00d4ff',
                            weight: Math.max(1, 2 - d/15),
                            opacity: Math.max(0.1, 0.4 - d/75),
                            dashArray: '6,10'
                        }).addTo(layerLinks);
                    }
                });
            });
        }
    }
    
    function locate() {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(
            p => {
                userPos = { lat: p.coords.latitude, lon: p.coords.longitude };
                map.setView([userPos.lat, userPos.lon], 11);
                renderList();
            },
            () => map.setView([50.5, 4.5], 8)
        );
    }
    
    function toggleLinks() {
        showLinks = !showLinks;
        document.getElementById('toggle-links').classList.toggle('active', showLinks);
        render();
    }
    
    // === SIDEBAR ===
    function renderList() {
        document.getElementById('sidebar-title').textContent = 'Cellules';
        
        let list = [...data.cellules];
        if (userPos) {
            list = list.map(c => ({ ...c, dist: dist(userPos.lat, userPos.lon, c.lat, c.lon) }))
                       .sort((a,b) => a.dist - b.dist);
        }
        
        let html = '';
        list.forEach(c => {
            const n = c.participants.length;
            const pct = (n / (c.max || 9)) * 100;
            const ready = n >= (c.min || 5);
            let badge = c.seed ? '<span class="badge badge-pink">Antenne</span>' :
                        ready ? '<span class="badge badge-green">Active</span>' :
                        '<span class="badge badge-yellow">Recrute</span>';
            const distTxt = c.dist ? ` ¬∑ ${c.dist.toFixed(1)} km` : '';
            
            html += `
                <div class="card" onclick="showDetail('${c.id}')">
                    <div class="card-title">${c.title} ${badge}</div>
                    <div class="card-meta">${n}/${c.max||9} participants${distTxt}</div>
                    <div class="progress"><div class="progress-fill" style="width:${pct}%"></div></div>
                </div>
            `;
        });
        
        html += `
            <div class="btn-group" style="margin-top:1.5rem;">
                <button class="btn btn-secondary" onclick="exportData()">üì§ Export</button>
                <button class="btn btn-secondary" onclick="importData()">üì• Import</button>
            </div>
        `;
        
        document.getElementById('sidebar-body').innerHTML = html;
    }
    
    function showDetail(id) {
        const c = data.cellules.find(x => x.id === id);
        if (!c) return;
        
        map.setView([c.lat, c.lon], 12);
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('sidebar-title').textContent = 'D√©tail';
        
        const n = c.participants.length;
        const ready = n >= (c.min || 5);
        const pct = (n / (c.max || 9)) * 100;
        const isMember = c.participants.some(p => p.name === user);
        const atelier = data.ateliers.find(a => a.celluleId === c.id);
        
        let html = `
            <button class="btn btn-back" onclick="renderList()">‚Üê Retour</button>
            <div class="detail-title">${c.title}</div>
            <div class="detail-meta">${THEMES[c.theme] || c.theme} ¬∑ Cr√©√© par ${c.creator}</div>
            <div class="detail-desc">${c.desc || ''}</div>
            
            <div class="section-title">Participants (${n}/${c.max||9})</div>
            <div class="progress" style="margin-bottom:1rem;"><div class="progress-fill" style="width:${pct}%"></div></div>
        `;
        
        c.participants.forEach((p, i) => {
            const isMe = p.name === user;
            const isCreator = i === 0 || p.role === 'seed';
            html += `<div class="participant"><span style="color:${isCreator?'#00ff9d':'#fff'}">${isCreator?'üëë ':''}${p.name}${isMe?' (vous)':''}</span></div>`;
        });
        
        if (!isMember && n < (c.max || 9)) {
            html += `<button class="btn btn-primary" style="margin-top:1rem;" onclick="join('${c.id}')">Rejoindre</button>`;
        } else if (isMember && !c.seed && c.participants.findIndex(p=>p.name===user) > 0) {
            html += `<button class="btn btn-secondary" style="margin-top:1rem;" onclick="leave('${c.id}')">Quitter</button>`;
        }
        
        // Atelier
        if (ready) {
            html += `<div class="section-title">Atelier</div>`;
            if (atelier) {
                html += `<div style="color:#888;font-size:0.85rem;">üìã <b>${atelier.title}</b><br>Statut: ${atelier.status}</div>`;
            } else if (isMember) {
                html += `<div style="color:#888;font-size:0.85rem;margin-bottom:0.5rem;">‚úÖ Quorum atteint !</div>`;
                html += `<button class="btn btn-primary" onclick="launchAtelier('${c.id}')">üöÄ Lancer un atelier</button>`;
            } else {
                html += `<div style="color:#888;font-size:0.85rem;">Cellule active</div>`;
            }
        }
        
        // Matches
        const matches = data.cellules
            .filter(x => x.id !== c.id && x.participants.length >= 5)
            .map(x => ({ ...x, d: dist(c.lat, c.lon, x.lat, x.lon) }))
            .filter(x => x.d < 30)
            .sort((a,b) => a.d - b.d)
            .slice(0, 3);
        
        if (matches.length) {
            html += `<div class="section-title">Cellules proches</div>`;
            matches.forEach(m => {
                html += `<div class="card" onclick="showDetail('${m.id}')"><div class="card-title">${m.title}</div><div class="card-meta">${m.d.toFixed(1)} km</div></div>`;
            });
        }
        
        document.getElementById('sidebar-body').innerHTML = html;
    }
    
    // === CREATE ===
    function openCreate() {
        const pos = clickedPos || userPos || { lat: 50.5, lon: 4.5 };
        
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('sidebar-title').textContent = 'Nouvelle cellule';
        
        let options = Object.entries(THEMES).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
        
        document.getElementById('sidebar-body').innerHTML = `
            <button class="btn btn-back" onclick="renderList()">‚Üê Annuler</button>
            
            <div class="form-group">
                <label class="form-label">Titre</label>
                <input class="form-input" id="f-title" placeholder="Ex: V√©lo-√©cole Ixelles">
            </div>
            <div class="form-group">
                <label class="form-label">Th√©matique</label>
                <select class="form-input" id="f-theme"><option value="">Choisir...</option>${options}</select>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="f-desc" placeholder="D√©crivez votre cellule..."></textarea>
            </div>
            <div style="color:#888;font-size:0.75rem;margin-bottom:1rem;">üìç ${pos.lat.toFixed(4)}, ${pos.lon.toFixed(4)}</div>
            <button class="btn btn-primary" onclick="create(${pos.lat},${pos.lon})">Cr√©er la cellule</button>
        `;
    }
    
    function create(lat, lon) {
        const title = document.getElementById('f-title').value.trim();
        const theme = document.getElementById('f-theme').value;
        const desc = document.getElementById('f-desc').value.trim();
        
        if (!title || !theme) { toast('Remplissez titre et th√©matique'); return; }
        
        const c = {
            id: 'c' + Date.now(),
            lat, lon, title, theme, desc,
            creator: user,
            participants: [{ name: user, role: 'creator' }],
            min: 5, max: 9, radius: 5
        };
        
        data.cellules.push(c);
        saveData();
        clickedPos = null;
        
        render();
        updateStats();
        showDetail(c.id);
        toast('Cellule cr√©√©e !');
    }
    
    // === ACTIONS ===
    function join(id) {
        const c = data.cellules.find(x => x.id === id);
        if (!c || c.participants.some(p => p.name === user)) return;
        if (c.participants.length >= (c.max || 9)) { toast('Cellule compl√®te'); return; }
        
        c.participants.push({ name: user });
        saveData();
        render();
        updateStats();
        showDetail(id);
        toast(c.participants.length >= (c.min||5) ? 'üéâ Quorum atteint !' : 'Bienvenue !');
    }
    
    function leave(id) {
        const c = data.cellules.find(x => x.id === id);
        if (!c) return;
        const idx = c.participants.findIndex(p => p.name === user);
        if (idx <= 0) return;
        
        c.participants.splice(idx, 1);
        saveData();
        render();
        updateStats();
        renderList();
        toast('Vous avez quitt√©');
    }
    
    function launchAtelier(celluleId) {
        const title = prompt('Titre de l\'atelier :', 'Atelier');
        if (!title) return;
        
        data.ateliers.push({
            id: 'a' + Date.now(),
            celluleId,
            title,
            status: 'async',
            startedAt: new Date().toISOString()
        });
        saveData();
        render();
        showDetail(celluleId);
        toast('üöÄ Atelier lanc√© !');
    }
    
    // === SYNC ===
    function exportData() {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'cellules.json';
        a.click();
        toast('Export√©');
    }
    
    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const imported = JSON.parse(ev.target.result);
                    let n = 0;
                    (imported.cellules || []).forEach(c => {
                        if (!data.cellules.some(x => x.id === c.id)) {
                            data.cellules.push(c);
                            n++;
                        }
                    });
                    (imported.ateliers || []).forEach(a => {
                        if (!data.ateliers.some(x => x.id === a.id)) {
                            data.ateliers.push(a);
                        }
                    });
                    saveData();
                    render();
                    renderList();
                    updateStats();
                    toast(`${n} cellule(s) import√©e(s)`);
                } catch (err) {
                    toast('Fichier invalide');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    // === UTILS ===
    function dist(lat1, lon1, lat2, lon2) {
        const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    
    function updateStats() {
        document.getElementById('stat-c').textContent = data.cellules.length;
        document.getElementById('stat-p').textContent = data.cellules.reduce((s,c) => s + c.participants.length, 0);
    }
    
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }
    
    function toast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }
    
    // === BOOT ===
    boot();
    </script>
</body>
</html>
