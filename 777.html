<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cellules Citoyennes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,system-ui,sans-serif; background:#030308; color:#fff; min-height:100vh; overflow:hidden; }
        
        /* === ONBOARDING === */
        #onboarding { position:fixed; inset:0; background:radial-gradient(ellipse at 50% 30%, #0a0a18 0%, #030308 70%); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem; text-align:center; }
        #onboarding.hidden { display:none; }
        #onboarding .glow-logo { font-size:5rem; margin-bottom:1rem; animation:logo-pulse 2s ease-in-out infinite; filter:drop-shadow(0 0 30px rgba(0,255,157,0.8)); }
        @keyframes logo-pulse { 0%,100%{transform:scale(1);filter:drop-shadow(0 0 20px rgba(0,255,157,0.6));} 50%{transform:scale(1.05);filter:drop-shadow(0 0 40px rgba(0,255,157,1));} }
        #onboarding h1 { font-family:'Orbitron',sans-serif; font-size:1.8rem; background:linear-gradient(135deg,#00ff9d,#00d4ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.5rem; }
        #onboarding p { color:#555; max-width:320px; line-height:1.6; margin-bottom:2rem; }
        #onboarding .steps { display:flex; gap:1.5rem; margin-bottom:2rem; }
        #onboarding .step { text-align:center; }
        #onboarding .step-icon { font-size:1.8rem; margin-bottom:0.4rem; }
        #onboarding .step-text { font-size:0.65rem; color:#444; }
        #onboarding input { width:100%; max-width:280px; padding:1rem; background:rgba(255,255,255,0.03); border:1px solid #1a1a2a; border-radius:0.5rem; color:#fff; font-size:1rem; margin-bottom:1rem; text-align:center; }
        #onboarding input:focus { outline:none; border-color:#00ff9d; box-shadow:0 0 30px rgba(0,255,157,0.15); }
        #onboarding input::placeholder { color:#333; }
        #onboarding button { background:linear-gradient(135deg,#00ff9d,#00d4ff); color:#000; border:none; padding:1rem 3rem; font-size:1rem; font-weight:700; cursor:pointer; border-radius:2rem; }
        #onboarding button:hover { box-shadow:0 0 50px rgba(0,255,157,0.6); transform:scale(1.02); }
        #onboarding .err { color:#ff3366; font-size:0.8rem; display:none; margin-bottom:1rem; }
        
        /* === APP === */
        #app { display:none; height:100vh; flex-direction:column; }
        #app.active { display:flex; }
        
        /* === HEADER === */
        header { background:rgba(8,8,15,0.95); backdrop-filter:blur(10px); padding:0.6rem 1rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,255,157,0.08); z-index:100; }
        .logo { font-family:'Orbitron',sans-serif; font-weight:700; font-size:0.9rem; color:#00ff9d; display:flex; align-items:center; gap:0.5rem; }
        .logo span { filter:drop-shadow(0 0 8px rgba(0,255,157,0.8)); }
        .stats { display:flex; gap:1rem; }
        .stat { text-align:center; }
        .stat-val { font-family:'Orbitron',sans-serif; font-weight:700; font-size:1rem; color:#00ff9d; text-shadow:0 0 10px rgba(0,255,157,0.5); }
        .stat-lbl { font-size:0.5rem; color:#444; text-transform:uppercase; }
        .header-btns { display:flex; gap:0.5rem; }
        .hdr-btn { background:rgba(0,255,157,0.1); border:1px solid rgba(0,255,157,0.2); color:#00ff9d; padding:0.4rem 0.7rem; cursor:pointer; font-size:0.7rem; border-radius:0.25rem; }
        .hdr-btn:hover { background:rgba(0,255,157,0.2); }
        .hdr-btn.active { background:#00ff9d; color:#000; }
        
        /* === MAIN === */
        main { flex:1; display:flex; position:relative; overflow:hidden; }
        
        /* === MAP === */
        #map-wrap { flex:1; position:relative; }
        #map { width:100%; height:100%; background:#030308; }
        .leaflet-tile-pane { filter:saturate(0) brightness(0.2) contrast(1.5); }
        .leaflet-control-zoom { border:none !important; margin-right:1rem !important; margin-bottom:1rem !important; }
        .leaflet-control-zoom a { background:rgba(8,8,15,0.9) !important; color:#00ff9d !important; border:1px solid rgba(0,255,157,0.2) !important; }
        
        #glow-canvas { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:350; mix-blend-mode:screen; }
        
        .locate-btn { position:absolute; top:1rem; right:1rem; z-index:500; width:40px; height:40px; background:rgba(8,8,15,0.9); border:1px solid rgba(255,255,255,0.08); border-radius:50%; color:#fff; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .locate-btn:hover { border-color:#00ff9d; color:#00ff9d; }
        
        .map-controls { position:absolute; bottom:1.5rem; left:1rem; z-index:500; display:flex; gap:0.5rem; }
        .map-btn { background:rgba(8,8,15,0.9); border:1px solid rgba(255,255,255,0.08); color:#666; padding:0.5rem 0.8rem; font-size:0.7rem; cursor:pointer; border-radius:2rem; display:flex; align-items:center; gap:0.3rem; }
        .map-btn:hover { border-color:rgba(0,255,157,0.3); color:#00ff9d; }
        .map-btn.active { background:linear-gradient(135deg,#00ff9d,#00d4ff); color:#000; border:none; font-weight:600; }
        
        .fab { position:absolute; bottom:1.5rem; right:1rem; z-index:500; width:56px; height:56px; background:linear-gradient(135deg,#00ff9d,#00d4ff); border:none; border-radius:50%; font-size:1.8rem; color:#000; cursor:pointer; box-shadow:0 4px 25px rgba(0,255,157,0.5); display:flex; align-items:center; justify-content:center; }
        .fab:hover { transform:scale(1.1) rotate(90deg); box-shadow:0 0 50px rgba(0,255,157,0.8); }
        
        .legend { position:absolute; top:1rem; left:1rem; z-index:500; background:rgba(8,8,15,0.9); border:1px solid rgba(255,255,255,0.08); padding:0.6rem 0.8rem; border-radius:0.4rem; font-size:0.6rem; }
        .legend-title { font-family:'Orbitron',sans-serif; font-size:0.5rem; color:#00d4ff; margin-bottom:0.4rem; letter-spacing:0.1em; }
        .legend-item { display:flex; align-items:center; gap:0.4rem; color:#555; margin-bottom:0.2rem; }
        .legend-dot { width:8px; height:8px; border-radius:50%; }
        
        /* === SIDEBAR === */
        #sidebar { width:400px; background:rgba(8,8,15,0.98); border-left:1px solid rgba(0,255,157,0.05); display:flex; flex-direction:column; }
        @media(max-width:900px) { #sidebar { position:fixed; top:0; right:0; bottom:0; width:100%; transform:translateX(100%); transition:transform 0.3s; z-index:1000; } #sidebar.open { transform:translateX(0); } }
        
        .sidebar-tabs { display:flex; border-bottom:1px solid rgba(255,255,255,0.05); }
        .sidebar-tab { flex:1; padding:0.75rem; background:none; border:none; color:#444; font-size:0.7rem; cursor:pointer; border-bottom:2px solid transparent; }
        .sidebar-tab:hover { color:#888; }
        .sidebar-tab.active { color:#00ff9d; border-bottom-color:#00ff9d; }
        
        .sidebar-header { padding:0.75rem 1rem; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; }
        .sidebar-title { font-family:'Orbitron',sans-serif; font-weight:500; font-size:0.75rem; color:#00ff9d; }
        .sidebar-close { display:none; background:none; border:none; color:#555; font-size:1.3rem; cursor:pointer; }
        @media(max-width:900px) { .sidebar-close { display:block; } }
        
        .sidebar-body { flex:1; overflow-y:auto; padding:1rem; }
        .sidebar-panel { display:none; }
        .sidebar-panel.active { display:block; }
        
        /* === CARDS === */
        .card { background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05); border-radius:0.5rem; padding:0.75rem; margin-bottom:0.5rem; cursor:pointer; transition:all 0.2s; position:relative; }
        .card:hover { border-color:var(--c, rgba(0,255,157,0.3)); transform:translateX(3px); }
        .card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.3rem; }
        .card-title { font-weight:600; font-size:0.8rem; flex:1; }
        .card-meta { font-size:0.65rem; color:#444; }
        .card-actions { display:flex; gap:0.3rem; margin-top:0.5rem; }
        .card-btn { background:rgba(255,255,255,0.05); border:none; color:#666; padding:0.3rem 0.5rem; font-size:0.6rem; cursor:pointer; border-radius:0.25rem; }
        .card-btn:hover { background:rgba(0,255,157,0.2); color:#00ff9d; }
        .card-btn.danger:hover { background:rgba(255,51,102,0.2); color:#ff3366; }
        
        .badge { font-size:0.5rem; padding:0.15rem 0.4rem; border-radius:1rem; font-weight:600; }
        .badge-y { background:rgba(255,234,0,0.15); color:#ffea00; }
        .badge-g { background:rgba(0,255,157,0.15); color:#00ff9d; }
        .badge-b { background:rgba(0,212,255,0.15); color:#00d4ff; }
        .badge-p { background:rgba(255,0,128,0.15); color:#ff0080; }
        .badge-r { background:rgba(255,51,102,0.15); color:#ff3366; }
        
        .progress { height:3px; background:rgba(255,255,255,0.05); border-radius:2px; margin-top:0.5rem; overflow:hidden; }
        .progress-fill { height:100%; border-radius:2px; }
        
        /* === FORMS === */
        .form-group { margin-bottom:1rem; }
        .form-label { display:block; font-size:0.6rem; color:#555; margin-bottom:0.25rem; text-transform:uppercase; letter-spacing:0.05em; }
        .form-input { width:100%; padding:0.7rem; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:0.4rem; color:#fff; font-size:0.85rem; }
        .form-input:focus { outline:none; border-color:rgba(0,255,157,0.4); }
        .form-input::placeholder { color:#333; }
        select.form-input { cursor:pointer; }
        textarea.form-input { min-height:70px; resize:vertical; font-family:inherit; }
        
        .btn { padding:0.7rem 1.25rem; border:none; font-size:0.75rem; font-weight:600; cursor:pointer; width:100%; border-radius:0.4rem; transition:all 0.2s; }
        .btn-primary { background:linear-gradient(135deg,#00ff9d,#00d4ff); color:#000; }
        .btn-primary:hover { box-shadow:0 0 25px rgba(0,255,157,0.5); }
        .btn-secondary { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); color:#666; }
        .btn-secondary:hover { border-color:rgba(0,255,157,0.3); color:#00ff9d; }
        .btn-danger { background:rgba(255,51,102,0.1); border:1px solid rgba(255,51,102,0.3); color:#ff3366; }
        .btn-danger:hover { background:rgba(255,51,102,0.2); }
        .btn-back { background:transparent; border:1px solid rgba(255,255,255,0.08); color:#555; margin-bottom:1rem; font-size:0.7rem; }
        .btn-group { display:flex; gap:0.5rem; margin-top:1rem; }
        .btn-group .btn { flex:1; }
        
        /* === DETAIL === */
        .detail-header { margin-bottom:1rem; }
        .detail-title { font-family:'Orbitron',sans-serif; font-size:1.1rem; font-weight:500; margin-bottom:0.3rem; }
        .detail-meta { font-size:0.7rem; color:#444; }
        .detail-desc { font-size:0.75rem; color:#666; line-height:1.5; margin-top:0.6rem; padding:0.6rem; background:rgba(255,255,255,0.02); border-radius:0.4rem; border-left:2px solid var(--c, #00ff9d); }
        .section-title { font-family:'Orbitron',sans-serif; font-size:0.55rem; color:#00d4ff; margin:1rem 0 0.6rem; letter-spacing:0.1em; }
        .participant { display:flex; justify-content:space-between; align-items:center; padding:0.4rem 0; font-size:0.75rem; border-bottom:1px solid rgba(255,255,255,0.03); }
        .participant:last-child { border:none; }
        .participant-btn { background:none; border:none; color:#ff3366; cursor:pointer; font-size:0.7rem; opacity:0.5; }
        .participant-btn:hover { opacity:1; }
        
        /* === WORKSTATION === */
        .ws-section { background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05); border-radius:0.5rem; padding:1rem; margin-bottom:1rem; }
        .ws-title { font-family:'Orbitron',sans-serif; font-size:0.65rem; color:#00d4ff; margin-bottom:0.75rem; }
        .ws-stat { display:flex; justify-content:space-between; padding:0.4rem 0; border-bottom:1px solid rgba(255,255,255,0.03); font-size:0.75rem; }
        .ws-stat:last-child { border:none; }
        .ws-stat-val { color:#00ff9d; font-weight:600; }
        
        .sync-box { background:rgba(0,255,157,0.05); border:1px dashed rgba(0,255,157,0.2); border-radius:0.5rem; padding:1rem; margin-bottom:1rem; }
        .sync-box textarea { width:100%; min-height:100px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.05); color:#888; font-size:0.65rem; font-family:monospace; padding:0.5rem; border-radius:0.25rem; resize:vertical; }
        
        /* === TOAST === */
        #toast { position:fixed; bottom:-80px; left:50%; transform:translateX(-50%); background:rgba(8,8,15,0.95); border:1px solid rgba(0,255,157,0.3); padding:0.75rem 1.5rem; border-radius:2rem; z-index:9999; transition:bottom 0.4s cubic-bezier(0.68,-0.55,0.265,1.55); font-size:0.8rem; }
        #toast.show { bottom:2rem; }
        
        /* === MODAL === */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; display:flex; align-items:center; justify-content:center; padding:1rem; opacity:0; pointer-events:none; transition:opacity 0.2s; }
        .modal.open { opacity:1; pointer-events:auto; }
        .modal-box { background:#0a0a12; border:1px solid rgba(0,255,157,0.2); border-radius:0.75rem; width:100%; max-width:400px; max-height:85vh; overflow-y:auto; }
        .modal-header { padding:1rem; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; }
        .modal-title { font-family:'Orbitron',sans-serif; font-size:0.8rem; color:#00ff9d; }
        .modal-close { background:none; border:none; color:#555; font-size:1.3rem; cursor:pointer; }
        .modal-body { padding:1rem; }
        
        ::-webkit-scrollbar { width:5px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:rgba(0,255,157,0.2); border-radius:3px; }
    </style>
</head>
<body>
    <div id="onboarding">
        <div class="glow-logo">‚ö°</div>
        <h1>Cellules Citoyennes</h1>
        <p>Cr√©ez des groupes de veille citoyenne et lancez des ateliers d'intelligence collective.</p>
        <div class="steps">
            <div class="step"><div class="step-icon">üìç</div><div class="step-text">Choisissez un lieu</div></div>
            <div class="step"><div class="step-icon">üë•</div><div class="step-text">5 √† 9 personnes</div></div>
            <div class="step"><div class="step-icon">üí¨</div><div class="step-text">Lancez un atelier</div></div>
        </div>
        <input type="text" id="pseudo-input" placeholder="Votre pseudo" autofocus>
        <div class="err" id="err">Entrez un pseudo</div>
        <button onclick="enterApp()">Commencer</button>
    </div>

    <div id="app">
        <header>
            <div class="logo"><span>‚ö°</span> Cellules</div>
            <div class="stats">
                <div class="stat"><div class="stat-val" id="stat-c">0</div><div class="stat-lbl">Cellules</div></div>
                <div class="stat"><div class="stat-val" id="stat-p">0</div><div class="stat-lbl">Citoyens</div></div>
                <div class="stat"><div class="stat-val" id="stat-a">0</div><div class="stat-lbl">Ateliers</div></div>
            </div>
            <div class="header-btns">
                <button class="hdr-btn" onclick="toggleSidebar()">‚ò∞</button>
            </div>
        </header>
        <main>
            <div id="map-wrap">
                <div id="map"></div>
                <canvas id="glow-canvas"></canvas>
                <div class="legend">
                    <div class="legend-title">TERRITOIRES</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ffea00;box-shadow:0 0 5px #ffea00;"></div> Recrutement</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00ff9d;box-shadow:0 0 5px #00ff9d;"></div> Active</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00d4ff;box-shadow:0 0 8px #00d4ff;"></div> Atelier</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ff0080;box-shadow:0 0 5px #ff0080;"></div> Antenne</div>
                </div>
                <button class="locate-btn" onclick="locate()">üìç</button>
                <div class="map-controls">
                    <button class="map-btn active" id="btn-zones" onclick="toggleZones()">‚óê Zones</button>
                    <button class="map-btn active" id="btn-links" onclick="toggleLinks()">‚üÅ R√©seau</button>
                </div>
                <button class="fab" onclick="openCreate()">+</button>
            </div>
            
            <aside id="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="cellules">üìç Cellules</button>
                    <button class="sidebar-tab" data-tab="ateliers">üìã Ateliers</button>
                    <button class="sidebar-tab" data-tab="workstation">‚öôÔ∏è Sync</button>
                </div>
                <div class="sidebar-header">
                    <span class="sidebar-title" id="sidebar-title">Cellules</span>
                    <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
                </div>
                <div class="sidebar-body">
                    <div class="sidebar-panel active" id="panel-cellules"></div>
                    <div class="sidebar-panel" id="panel-ateliers"></div>
                    <div class="sidebar-panel" id="panel-workstation"></div>
                    <div class="sidebar-panel" id="panel-detail"></div>
                    <div class="sidebar-panel" id="panel-create"></div>
                    <div class="sidebar-panel" id="panel-edit"></div>
                </div>
            </aside>
        </main>
    </div>

    <div id="toast"></div>
    
    <div class="modal" id="modal">
        <div class="modal-box">
            <div class="modal-header">
                <span class="modal-title" id="modal-title"></span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    const KEY='cellules_v4', THEMES={
        mobilite:{e:'üö≤',l:'Mobilit√©',c:'#00ff9d'},
        environnement:{e:'üå±',l:'Environnement',c:'#22cc77'},
        social:{e:'ü§ù',l:'Social',c:'#ff9d00'},
        numerique:{e:'üíª',l:'Num√©rique',c:'#00d4ff'},
        culture:{e:'üé≠',l:'Culture',c:'#ff00ff'},
        economie:{e:'üíº',l:'√âconomie',c:'#ffea00'},
        democratie:{e:'üó≥Ô∏è',l:'D√©mocratie',c:'#ff3366'},
        education:{e:'üìö',l:'√âducation',c:'#9d00ff'},
        sante:{e:'üè•',l:'Sant√©',c:'#00ffcc'},
        autre:{e:'üìã',l:'Autre',c:'#888'}
    }, SEEDS=[
        {id:'s1',lat:50.8466,lon:4.3528,title:'Antenne Bruxelles',theme:'democratie',desc:'Point de ralliement Bruxelles',radius:12},
        {id:'s2',lat:50.4669,lon:4.8675,title:'Antenne Namur',theme:'democratie',desc:'Point de ralliement Namur',radius:15},
        {id:'s3',lat:50.6326,lon:5.5797,title:'Antenne Li√®ge',theme:'social',desc:'Point de ralliement Li√®ge',radius:12},
        {id:'s4',lat:50.4108,lon:4.4446,title:'Antenne Charleroi',theme:'social',desc:'Point de ralliement Charleroi',radius:10},
        {id:'s5',lat:50.4542,lon:3.9523,title:'Antenne Mons',theme:'culture',desc:'Point de ralliement Mons',radius:10}
    ];
    
    let map,layers={},data,user,userPos,clickedPos,showZones=true,showLinks=true,glowCanvas,glowCtx,currentTab='cellules';
    
    // === INIT ===
    function boot(){user=localStorage.getItem('cellules_user');data=load();if(user)startApp();}
    function load(){const s=localStorage.getItem(KEY);if(s)return JSON.parse(s);const d={cellules:SEEDS.map(s=>({...s,seed:true,creator:'R√©seau',participants:[{name:'R√©seau',role:'seed'}],min:5,max:15,createdAt:new Date().toISOString()})),ateliers:[]};localStorage.setItem(KEY,JSON.stringify(d));return d;}
    function save(){localStorage.setItem(KEY,JSON.stringify(data));}
    
    function enterApp(){const i=document.getElementById('pseudo-input'),e=document.getElementById('err'),p=i.value.trim();if(!p){e.style.display='block';i.focus();return;}user=p;localStorage.setItem('cellules_user',p);startApp();}
    function startApp(){document.getElementById('onboarding').classList.add('hidden');document.getElementById('app').classList.add('active');if(typeof L==='undefined'){setTimeout(startApp,100);return;}initMap();initGlow();initTabs();}
    
    // === TABS ===
    function initTabs(){
        document.querySelectorAll('.sidebar-tab').forEach(t=>{
            t.addEventListener('click',()=>{
                document.querySelectorAll('.sidebar-tab').forEach(x=>x.classList.remove('active'));
                t.classList.add('active');
                currentTab=t.dataset.tab;
                showPanel(currentTab);
                if(currentTab==='cellules')renderList();
                else if(currentTab==='ateliers')renderAteliers();
                else if(currentTab==='workstation')renderWorkstation();
            });
        });
    }
    
    function showPanel(name){
        document.querySelectorAll('.sidebar-panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+name).classList.add('active');
        document.getElementById('sidebar-title').textContent={cellules:'Cellules',ateliers:'Ateliers',workstation:'Workstation',detail:'D√©tail',create:'Nouvelle',edit:'Modifier'}[name]||'';
    }
    
    // === MAP ===
    function initMap(){
        map=L.map('map',{center:[50.5,4.5],zoom:8,zoomControl:false});
        L.control.zoom({position:'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);
        layers.zones=L.layerGroup().addTo(map);
        layers.links=L.layerGroup().addTo(map);
        layers.markers=L.layerGroup().addTo(map);
        map.on('click',e=>{clickedPos={lat:e.latlng.lat,lon:e.latlng.lng};openCreate();});
        map.on('moveend zoomend',renderGlow);
        render();renderList();updateStats();locate();
    }
    
    function render(){
        layers.zones.clearLayers();layers.links.clearLayers();layers.markers.clearLayers();
        
        if(showZones){
            data.cellules.forEach(c=>{
                const t=THEMES[c.theme]||THEMES.autre,r=(c.radius||5)*1000,n=c.participants.length,rdy=n>=(c.min||5),atl=data.ateliers.some(a=>a.celluleId===c.id&&a.status!=='completed');
                L.circle([c.lat,c.lon],{radius:r*1.8,color:'transparent',fillColor:t.c,fillOpacity:0.015,weight:0}).addTo(layers.zones);
                L.circle([c.lat,c.lon],{radius:r,color:t.c,fillColor:t.c,fillOpacity:rdy?0.08:0.03,weight:rdy?2:1,opacity:rdy?0.5:0.2,dashArray:rdy?null:'8,8'}).addTo(layers.zones);
                if(rdy)L.circle([c.lat,c.lon],{radius:r*0.25,color:t.c,fillColor:t.c,fillOpacity:0.2,weight:1,opacity:0.7}).addTo(layers.zones);
                if(atl)L.circle([c.lat,c.lon],{radius:r*1.2,color:'#00d4ff',fillColor:'transparent',fillOpacity:0,weight:2,opacity:0.4,dashArray:'4,8'}).addTo(layers.zones);
            });
        }
        
        if(showLinks){
            const active=data.cellules.filter(c=>c.participants.length>=5);
            active.forEach((a,i)=>{
                active.slice(i+1).forEach(b=>{
                    const d=dist(a.lat,a.lon,b.lat,b.lon);
                    if(d<40){
                        const ca=THEMES[a.theme]?.c||'#00d4ff',w=Math.max(1,4-d/12),o=Math.max(0.1,0.5-d/80);
                        L.polyline([[a.lat,a.lon],[b.lat,b.lon]],{color:ca,weight:w*3,opacity:o*0.2}).addTo(layers.links);
                        L.polyline([[a.lat,a.lon],[b.lat,b.lon]],{color:'#00d4ff',weight:w,opacity:o,dashArray:'6,12'}).addTo(layers.links);
                    }
                });
            });
        }
        
        data.cellules.forEach(c=>{
            const t=THEMES[c.theme]||THEMES.autre,n=c.participants.length,rdy=n>=(c.min||5),atl=data.ateliers.some(a=>a.celluleId===c.id&&a.status!=='completed'),sz=Math.min(18,7+n*1.5);
            let col='#ffea00';if(rdy)col='#00ff9d';if(atl)col='#00d4ff';if(c.seed)col='#ff0080';
            if(rdy||atl)L.circleMarker([c.lat,c.lon],{radius:sz+10,color:'transparent',fillColor:col,fillOpacity:atl?0.25:0.12,weight:0}).addTo(layers.markers);
            const m=L.circleMarker([c.lat,c.lon],{radius:sz,color:'#fff',fillColor:col,fillOpacity:1,weight:2,opacity:0.9});
            m.on('click',e=>{L.DomEvent.stopPropagation(e);showDetail(c.id);});
            m.bindTooltip(`<b style="color:${t.c}">${t.e} ${c.title}</b><br><span style="color:#888">${n} participant${n>1?'s':''}</span>`,{direction:'top',offset:[0,-sz]});
            m.addTo(layers.markers);
        });
        
        renderGlow();
    }
    
    function initGlow(){glowCanvas=document.getElementById('glow-canvas');glowCtx=glowCanvas.getContext('2d');resizeGlow();window.addEventListener('resize',resizeGlow);animateGlow();}
    function resizeGlow(){const w=document.getElementById('map-wrap');glowCanvas.width=w.offsetWidth;glowCanvas.height=w.offsetHeight;renderGlow();}
    function renderGlow(){
        if(!glowCtx||!map)return;glowCtx.clearRect(0,0,glowCanvas.width,glowCanvas.height);
        data.cellules.forEach(c=>{
            const atl=data.ateliers.some(a=>a.celluleId===c.id&&a.status!=='completed');if(!atl)return;
            const pt=map.latLngToContainerPoint([c.lat,c.lon]),t=THEMES[c.theme]||THEMES.autre,time=Date.now()/1000,pulse=0.6+0.4*Math.sin(time*2),rad=50*pulse;
            const g=glowCtx.createRadialGradient(pt.x,pt.y,0,pt.x,pt.y,rad);
            g.addColorStop(0,t.c+'60');g.addColorStop(0.4,t.c+'25');g.addColorStop(1,'transparent');
            glowCtx.fillStyle=g;glowCtx.beginPath();glowCtx.arc(pt.x,pt.y,rad,0,Math.PI*2);glowCtx.fill();
        });
    }
    function animateGlow(){renderGlow();requestAnimationFrame(animateGlow);}
    
    function locate(){if(!navigator.geolocation)return;navigator.geolocation.getCurrentPosition(p=>{userPos={lat:p.coords.latitude,lon:p.coords.longitude};map.setView([userPos.lat,userPos.lon],10);renderList();},()=>map.setView([50.5,4.5],8));}
    function toggleZones(){showZones=!showZones;document.getElementById('btn-zones').classList.toggle('active',showZones);render();}
    function toggleLinks(){showLinks=!showLinks;document.getElementById('btn-links').classList.toggle('active',showLinks);render();}
    function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}
    
    // === CELLULES LIST ===
    function renderList(){
        let list=[...data.cellules];
        if(userPos)list=list.map(c=>({...c,d:dist(userPos.lat,userPos.lon,c.lat,c.lon)})).sort((a,b)=>a.d-b.d);
        
        let h=`<button class="btn btn-primary" onclick="openCreate()" style="margin-bottom:1rem;">+ Cr√©er une cellule</button>`;
        
        list.forEach(c=>{
            const t=THEMES[c.theme]||THEMES.autre,n=c.participants.length,pct=(n/(c.max||9))*100,rdy=n>=(c.min||5),atl=data.ateliers.some(a=>a.celluleId===c.id&&a.status!=='completed');
            let bdg=c.seed?'<span class="badge badge-p">Antenne</span>':atl?'<span class="badge badge-b">Atelier</span>':rdy?'<span class="badge badge-g">Active</span>':'<span class="badge badge-y">Recrute</span>';
            h+=`<div class="card" style="--c:${t.c}">
                <div class="card-header" onclick="showDetail('${c.id}')"><div class="card-title">${t.e} ${c.title}</div>${bdg}</div>
                <div class="card-meta" onclick="showDetail('${c.id}')">${n}/${c.max||9}${c.d?' ¬∑ '+c.d.toFixed(1)+' km':''}</div>
                <div class="progress" onclick="showDetail('${c.id}')"><div class="progress-fill" style="width:${pct}%;background:linear-gradient(90deg,${t.c},${t.c}88);"></div></div>
                <div class="card-actions">
                    <button class="card-btn" onclick="showDetail('${c.id}')">üëÅÔ∏è Voir</button>
                    ${!c.seed?`<button class="card-btn" onclick="editCellule('${c.id}')">‚úèÔ∏è Modifier</button>
                    <button class="card-btn danger" onclick="deleteCellule('${c.id}')">üóëÔ∏è Suppr.</button>`:''}
                </div>
            </div>`;
        });
        
        document.getElementById('panel-cellules').innerHTML=h;
        showPanel('cellules');
    }
    
    // === ATELIERS LIST ===
    function renderAteliers(){
        const active=data.ateliers.filter(a=>a.status!=='completed');
        const done=data.ateliers.filter(a=>a.status==='completed');
        
        let h='';
        
        if(active.length){
            h+=`<div class="section-title">üî¥ EN COURS</div>`;
            active.forEach(a=>{
                const c=data.cellules.find(x=>x.id===a.celluleId);
                h+=`<div class="card">
                    <div class="card-header"><div class="card-title">${a.title}</div><span class="badge badge-b">${a.status==='live'?'Live':'Async'}</span></div>
                    <div class="card-meta">${c?.title||''} ¬∑ ${a.contributions?.length||0} contributions</div>
                    <div class="card-actions">
                        <button class="card-btn" onclick="viewAtelier('${a.id}')">üëÅÔ∏è Voir</button>
                        <button class="card-btn" onclick="editAtelier('${a.id}')">‚úèÔ∏è Modifier</button>
                        <button class="card-btn" onclick="addContribution('${a.id}')">üí¨ Contribuer</button>
                        <button class="card-btn" onclick="completeAtelier('${a.id}')">‚úÖ Cl√¥turer</button>
                    </div>
                </div>`;
            });
        }
        
        if(done.length){
            h+=`<div class="section-title" style="margin-top:1.5rem;">‚úÖ TERMIN√âS</div>`;
            done.forEach(a=>{
                const c=data.cellules.find(x=>x.id===a.celluleId);
                h+=`<div class="card">
                    <div class="card-header"><div class="card-title">${a.title}</div><span class="badge badge-g">Termin√©</span></div>
                    <div class="card-meta">${c?.title||''} ¬∑ ${a.outcomes?.length||0} d√©cisions</div>
                    <div class="card-actions">
                        <button class="card-btn" onclick="viewAtelier('${a.id}')">üëÅÔ∏è Voir</button>
                        <button class="card-btn danger" onclick="deleteAtelier('${a.id}')">üóëÔ∏è Suppr.</button>
                    </div>
                </div>`;
            });
        }
        
        if(!active.length&&!done.length){
            h=`<div style="text-align:center;padding:2rem;color:#444;">
                <div style="font-size:2rem;margin-bottom:0.5rem;">üìã</div>
                <div>Aucun atelier pour l'instant</div>
                <div style="font-size:0.75rem;margin-top:0.5rem;">Atteignez le quorum (5 pers.) dans une cellule pour lancer un atelier.</div>
            </div>`;
        }
        
        document.getElementById('panel-ateliers').innerHTML=h;
        showPanel('ateliers');
    }
    
    // === WORKSTATION ===
    function renderWorkstation(){
        const totalCellules=data.cellules.length;
        const totalParticipants=data.cellules.reduce((s,c)=>s+c.participants.length,0);
        const activeCellules=data.cellules.filter(c=>c.participants.length>=5).length;
        const activeAteliers=data.ateliers.filter(a=>a.status!=='completed').length;
        
        let h=`
        <div class="ws-section">
            <div class="ws-title">üìä STATISTIQUES</div>
            <div class="ws-stat"><span>Cellules totales</span><span class="ws-stat-val">${totalCellules}</span></div>
            <div class="ws-stat"><span>Cellules actives (‚â•5)</span><span class="ws-stat-val">${activeCellules}</span></div>
            <div class="ws-stat"><span>Participants totaux</span><span class="ws-stat-val">${totalParticipants}</span></div>
            <div class="ws-stat"><span>Ateliers en cours</span><span class="ws-stat-val">${activeAteliers}</span></div>
            <div class="ws-stat"><span>Ateliers termin√©s</span><span class="ws-stat-val">${data.ateliers.filter(a=>a.status==='completed').length}</span></div>
        </div>
        
        <div class="ws-section">
            <div class="ws-title">üì§ EXPORTER</div>
            <p style="font-size:0.7rem;color:#555;margin-bottom:0.75rem;">T√©l√©chargez vos donn√©es pour les sauvegarder ou les partager.</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportJSON()">üì¶ T√©l√©charger JSON</button>
                <button class="btn btn-secondary" onclick="copyJSON()">üìã Copier</button>
            </div>
        </div>
        
        <div class="ws-section">
            <div class="ws-title">üì• IMPORTER</div>
            <p style="font-size:0.7rem;color:#555;margin-bottom:0.75rem;">Fusionnez des donn√©es depuis un autre appareil ou utilisateur.</p>
            <div class="sync-box">
                <textarea id="import-json" placeholder='Collez le JSON ici...\n{"cellules": [...], "ateliers": [...]}'></textarea>
            </div>
            <button class="btn btn-primary" onclick="importJSON()">Importer et fusionner</button>
        </div>
        
        <div class="ws-section">
            <div class="ws-title">üîÑ R√âINITIALISER</div>
            <p style="font-size:0.7rem;color:#555;margin-bottom:0.75rem;">Revenir aux donn√©es de d√©monstration (supprime tout).</p>
            <button class="btn btn-danger" onclick="resetData()">R√©initialiser</button>
        </div>
        
        <div class="ws-section">
            <div class="ws-title">üë§ UTILISATEUR</div>
            <div class="ws-stat"><span>Pseudo actuel</span><span class="ws-stat-val">${user}</span></div>
            <button class="btn btn-secondary" style="margin-top:0.75rem;" onclick="changeUser()">Changer de pseudo</button>
        </div>
        `;
        
        document.getElementById('panel-workstation').innerHTML=h;
        showPanel('workstation');
    }
    
    // === DETAIL ===
    function showDetail(id){
        const c=data.cellules.find(x=>x.id===id);if(!c)return;
        map.setView([c.lat,c.lon],12);document.getElementById('sidebar').classList.add('open');
        
        const t=THEMES[c.theme]||THEMES.autre,n=c.participants.length,rdy=n>=(c.min||5),pct=(n/(c.max||9))*100,isMember=c.participants.some(p=>p.name===user),atl=data.ateliers.find(a=>a.celluleId===c.id&&a.status!=='completed');
        
        let h=`<button class="btn btn-back" onclick="renderList()">‚Üê Retour</button>
        <div class="detail-header"><div class="detail-title" style="color:${t.c}">${t.e} ${c.title}</div><div class="detail-meta">${t.l} ¬∑ par ${c.creator}</div>${c.desc?`<div class="detail-desc" style="--c:${t.c}">${c.desc}</div>`:''}</div>
        
        <div class="section-title">PARTICIPANTS (${n}/${c.max||9})</div>
        <div class="progress" style="margin-bottom:0.75rem;"><div class="progress-fill" style="width:${pct}%;background:linear-gradient(90deg,${t.c},${t.c}88);"></div></div>`;
        
        c.participants.forEach((p,i)=>{
            const me=p.name===user,cr=i===0||p.role==='seed';
            h+=`<div class="participant">
                <span style="color:${cr?'#00ff9d':me?'#00d4ff':'#888'}">${cr?'üëë ':''}${p.name}${me?' (vous)':''}</span>
                ${!cr&&(me||c.creator===user)?`<button class="participant-btn" onclick="removeParticipant('${c.id}','${p.name}')">‚úï</button>`:''}
            </div>`;
        });
        
        if(!isMember&&n<(c.max||9))h+=`<button class="btn btn-primary" style="margin-top:0.75rem;" onclick="join('${c.id}')">Rejoindre</button>`;
        else if(isMember&&!c.seed&&c.participants.findIndex(p=>p.name===user)>0)h+=`<button class="btn btn-secondary" style="margin-top:0.75rem;" onclick="leave('${c.id}')">Quitter</button>`;
        
        if(rdy){
            h+=`<div class="section-title">ATELIER</div>`;
            if(atl){
                h+=`<div style="padding:0.6rem;background:rgba(0,212,255,0.1);border-radius:0.4rem;border:1px solid rgba(0,212,255,0.2);">
                    <div style="color:#00d4ff;font-weight:600;">üìã ${atl.title}</div>
                    <div style="font-size:0.7rem;color:#555;margin-top:0.25rem;">Statut: ${atl.status==='live'?'üî¥ Live':'‚è≥ Async'} ¬∑ ${atl.contributions?.length||0} contributions</div>
                    <div class="btn-group" style="margin-top:0.5rem;">
                        <button class="btn btn-secondary" onclick="viewAtelier('${atl.id}')" style="font-size:0.65rem;">Voir</button>
                        <button class="btn btn-secondary" onclick="addContribution('${atl.id}')" style="font-size:0.65rem;">Contribuer</button>
                    </div>
                </div>`;
            }else if(isMember){
                h+=`<div style="padding:0.6rem;background:rgba(0,255,157,0.1);border-radius:0.4rem;border:1px solid rgba(0,255,157,0.2);margin-bottom:0.5rem;">
                    <div style="color:#00ff9d;font-weight:600;">‚úÖ Quorum atteint !</div>
                </div>`;
                h+=`<button class="btn btn-primary" onclick="launchAtelier('${c.id}')">üöÄ Lancer un atelier</button>`;
            }
        }
        
        if(!c.seed){
            h+=`<div class="section-title">ACTIONS</div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="editCellule('${c.id}')">‚úèÔ∏è Modifier</button>
                <button class="btn btn-danger" onclick="deleteCellule('${c.id}')">üóëÔ∏è Supprimer</button>
            </div>`;
        }
        
        document.getElementById('panel-detail').innerHTML=h;
        showPanel('detail');
    }
    
    // === CREATE ===
    function openCreate(){
        const pos=clickedPos||userPos||{lat:50.5,lon:4.5};document.getElementById('sidebar').classList.add('open');
        let opts=Object.entries(THEMES).map(([k,v])=>`<option value="${k}">${v.e} ${v.l}</option>`).join('');
        document.getElementById('panel-create').innerHTML=`<button class="btn btn-back" onclick="renderList()">‚Üê Annuler</button>
        <div class="form-group"><label class="form-label">Titre *</label><input class="form-input" id="f-title" placeholder="Ex: V√©lo-√©cole Ixelles"></div>
        <div class="form-group"><label class="form-label">Th√©matique *</label><select class="form-input" id="f-theme"><option value="">Choisir...</option>${opts}</select></div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="f-desc" placeholder="D√©crivez votre cellule..."></textarea></div>
        <div class="form-group"><label class="form-label">Rayon d'influence (km)</label><input type="number" class="form-input" id="f-radius" value="5" min="1" max="20"></div>
        <div class="form-group"><label class="form-label">Participants min/max</label><div style="display:flex;gap:0.5rem;"><input type="number" class="form-input" id="f-min" value="5" min="3" max="15" style="flex:1;"><input type="number" class="form-input" id="f-max" value="9" min="5" max="20" style="flex:1;"></div></div>
        <div style="color:#444;font-size:0.65rem;margin-bottom:1rem;text-align:center;">üìç ${pos.lat.toFixed(4)}, ${pos.lon.toFixed(4)}</div>
        <button class="btn btn-primary" onclick="createCellule(${pos.lat},${pos.lon})">Cr√©er la cellule</button>`;
        showPanel('create');
    }
    
    function createCellule(lat,lon){
        const title=document.getElementById('f-title').value.trim(),theme=document.getElementById('f-theme').value,desc=document.getElementById('f-desc').value.trim(),radius=parseFloat(document.getElementById('f-radius').value)||5,min=parseInt(document.getElementById('f-min').value)||5,max=parseInt(document.getElementById('f-max').value)||9;
        if(!title||!theme){toast('Titre et th√©matique requis');return;}
        const c={id:'c'+Date.now(),lat,lon,title,theme,desc,radius,creator:user,participants:[{name:user,role:'creator'}],min,max,createdAt:new Date().toISOString()};
        data.cellules.push(c);save();clickedPos=null;render();updateStats();showDetail(c.id);toast('Cellule cr√©√©e !');
    }
    
    // === EDIT CELLULE ===
    function editCellule(id){
        const c=data.cellules.find(x=>x.id===id);if(!c||c.seed)return;
        document.getElementById('sidebar').classList.add('open');
        let opts=Object.entries(THEMES).map(([k,v])=>`<option value="${k}" ${k===c.theme?'selected':''}>${v.e} ${v.l}</option>`).join('');
        document.getElementById('panel-edit').innerHTML=`<button class="btn btn-back" onclick="showDetail('${id}')">‚Üê Annuler</button>
        <div class="form-group"><label class="form-label">Titre *</label><input class="form-input" id="e-title" value="${c.title}"></div>
        <div class="form-group"><label class="form-label">Th√©matique *</label><select class="form-input" id="e-theme">${opts}</select></div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="e-desc">${c.desc||''}</textarea></div>
        <div class="form-group"><label class="form-label">Rayon (km)</label><input type="number" class="form-input" id="e-radius" value="${c.radius||5}" min="1" max="20"></div>
        <div class="form-group"><label class="form-label">Participants min/max</label><div style="display:flex;gap:0.5rem;"><input type="number" class="form-input" id="e-min" value="${c.min||5}" min="3" max="15" style="flex:1;"><input type="number" class="form-input" id="e-max" value="${c.max||9}" min="5" max="20" style="flex:1;"></div></div>
        <button class="btn btn-primary" onclick="saveCellule('${id}')">Enregistrer</button>`;
        showPanel('edit');
    }
    
    function saveCellule(id){
        const c=data.cellules.find(x=>x.id===id);if(!c)return;
        c.title=document.getElementById('e-title').value.trim()||c.title;
        c.theme=document.getElementById('e-theme').value||c.theme;
        c.desc=document.getElementById('e-desc').value.trim();
        c.radius=parseFloat(document.getElementById('e-radius').value)||5;
        c.min=parseInt(document.getElementById('e-min').value)||5;
        c.max=parseInt(document.getElementById('e-max').value)||9;
        c.updatedAt=new Date().toISOString();
        save();render();showDetail(id);toast('Cellule mise √† jour');
    }
    
    function deleteCellule(id){
        const c=data.cellules.find(x=>x.id===id);if(!c||c.seed)return;
        if(!confirm(`Supprimer "${c.title}" et tous ses ateliers ?`))return;
        data.cellules=data.cellules.filter(x=>x.id!==id);
        data.ateliers=data.ateliers.filter(a=>a.celluleId!==id);
        save();render();updateStats();renderList();toast('Cellule supprim√©e');
    }
    
    // === PARTICIPANTS ===
    function join(id){const c=data.cellules.find(x=>x.id===id);if(!c||c.participants.some(p=>p.name===user))return;if(c.participants.length>=(c.max||9)){toast('Cellule compl√®te');return;}c.participants.push({name:user,joinedAt:new Date().toISOString()});save();render();updateStats();showDetail(id);toast(c.participants.length>=(c.min||5)?'üéâ Quorum atteint !':'Bienvenue !');}
    function leave(id){const c=data.cellules.find(x=>x.id===id);if(!c)return;const i=c.participants.findIndex(p=>p.name===user);if(i<=0)return;c.participants.splice(i,1);save();render();updateStats();renderList();toast('Quitt√©');}
    function removeParticipant(celluleId,name){const c=data.cellules.find(x=>x.id===celluleId);if(!c)return;const i=c.participants.findIndex(p=>p.name===name);if(i<=0)return;if(!confirm(`Retirer ${name} ?`))return;c.participants.splice(i,1);save();render();updateStats();showDetail(celluleId);toast('Participant retir√©');}
    
    // === ATELIERS ===
    function launchAtelier(celluleId){
        openModal('Lancer un atelier',`
            <div class="form-group"><label class="form-label">Titre *</label><input class="form-input" id="a-title" value="Atelier"></div>
            <div class="form-group"><label class="form-label">Plateformes (optionnel)</label><input class="form-input" id="a-platforms" placeholder="Ex: Jitsi, Pad, Discord..."></div>
            <button class="btn btn-primary" onclick="confirmLaunchAtelier('${celluleId}')">üöÄ Lancer</button>
        `);
    }
    
    function confirmLaunchAtelier(celluleId){
        const title=document.getElementById('a-title').value.trim()||'Atelier';
        const platforms=document.getElementById('a-platforms').value.trim();
        const now=new Date();
        data.ateliers.push({
            id:'a'+Date.now(),
            celluleId,
            title,
            status:'async',
            platforms,
            asyncStart:now.toISOString(),
            asyncEnd:new Date(now.getTime()+14*24*60*60*1000).toISOString(),
            contributions:[],
            outcomes:[],
            createdAt:now.toISOString()
        });
        save();closeModal();render();updateStats();showDetail(celluleId);toast('üöÄ Atelier lanc√© !');
    }
    
    function viewAtelier(id){
        const a=data.ateliers.find(x=>x.id===id);if(!a)return;
        const c=data.cellules.find(x=>x.id===a.celluleId);
        let contribs=a.contributions?.map(x=>`<div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-left:2px solid #00d4ff;margin-bottom:0.5rem;"><div style="font-size:0.65rem;color:#00ff9d;margin-bottom:0.2rem;">${x.author} <span style="color:#555;">¬∑ ${x.votes||0} votes</span></div><div style="font-size:0.75rem;color:#888;">${x.text}</div></div>`).join('')||'<div style="color:#444;font-size:0.75rem;">Aucune contribution</div>';
        let outcomes=a.outcomes?.map(x=>`<div style="padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.75rem;color:#00ff9d;">‚úì ${x}</div>`).join('')||'';
        
        openModal(a.title,`
            <div style="font-size:0.75rem;color:#555;margin-bottom:1rem;">${c?.title||''} ¬∑ ${a.status==='completed'?'Termin√©':a.status==='live'?'üî¥ Live':'‚è≥ Async'}</div>
            ${a.platforms?`<div style="font-size:0.7rem;color:#444;margin-bottom:1rem;">Plateformes: ${a.platforms}</div>`:''}
            <div class="section-title">CONTRIBUTIONS (${a.contributions?.length||0})</div>
            ${contribs}
            ${a.outcomes?.length?`<div class="section-title">D√âCISIONS</div>${outcomes}`:''}
            <div class="btn-group" style="margin-top:1rem;">
                ${a.status!=='completed'?`<button class="btn btn-secondary" onclick="addContribution('${id}');closeModal();">üí¨ Contribuer</button>`:''}
                ${a.status!=='completed'?`<button class="btn btn-secondary" onclick="editAtelier('${id}');closeModal();">‚úèÔ∏è Modifier</button>`:''}
            </div>
        `);
    }
    
    function editAtelier(id){
        const a=data.ateliers.find(x=>x.id===id);if(!a)return;
        openModal('Modifier l\'atelier',`
            <div class="form-group"><label class="form-label">Titre</label><input class="form-input" id="ea-title" value="${a.title}"></div>
            <div class="form-group"><label class="form-label">Statut</label><select class="form-input" id="ea-status"><option value="async" ${a.status==='async'?'selected':''}>Async (14j)</option><option value="live" ${a.status==='live'?'selected':''}>Live (48h)</option><option value="completed" ${a.status==='completed'?'selected':''}>Termin√©</option></select></div>
            <div class="form-group"><label class="form-label">Plateformes</label><input class="form-input" id="ea-platforms" value="${a.platforms||''}"></div>
            <button class="btn btn-primary" onclick="saveAtelier('${id}')">Enregistrer</button>
        `);
    }
    
    function saveAtelier(id){
        const a=data.ateliers.find(x=>x.id===id);if(!a)return;
        a.title=document.getElementById('ea-title').value.trim()||a.title;
        a.status=document.getElementById('ea-status').value;
        a.platforms=document.getElementById('ea-platforms').value.trim();
        a.updatedAt=new Date().toISOString();
        save();closeModal();render();updateStats();renderAteliers();toast('Atelier mis √† jour');
    }
    
    function addContribution(id){
        const a=data.ateliers.find(x=>x.id===id);if(!a||a.status==='completed')return;
        openModal('Ajouter une contribution',`
            <div class="form-group"><label class="form-label">Votre proposition</label><textarea class="form-input" id="contrib-text" placeholder="D√©crivez votre id√©e, proposition ou synth√®se..."></textarea></div>
            <button class="btn btn-primary" onclick="saveContribution('${id}')">Publier</button>
        `);
    }
    
    function saveContribution(id){
        const a=data.ateliers.find(x=>x.id===id);if(!a)return;
        const text=document.getElementById('contrib-text').value.trim();if(!text){toast('Texte requis');return;}
        if(!a.contributions)a.contributions=[];
        a.contributions.push({author:user,text,votes:0,createdAt:new Date().toISOString()});
        save();closeModal();toast('Contribution ajout√©e');viewAtelier(id);
    }
    
    function completeAtelier(id){
        const a=data.ateliers.find(x=>x.id===id);if(!a)return;
        openModal('Cl√¥turer l\'atelier',`
            <p style="font-size:0.75rem;color:#555;margin-bottom:1rem;">R√©sumez les d√©cisions prises (une par ligne) :</p>
            <div class="form-group"><textarea class="form-input" id="outcomes-text" placeholder="D√©cision 1\nD√©cision 2\n..." style="min-height:120px;"></textarea></div>
            <button class="btn btn-primary" onclick="confirmComplete('${id}')">‚úÖ Cl√¥turer</button>
        `);
    }
    
    function confirmComplete(id){
        const a=data.ateliers.find(x=>x.id===id);if(!a)return;
        const text=document.getElementById('outcomes-text').value.trim();
        a.outcomes=text.split('\n').map(x=>x.trim()).filter(x=>x);
        a.status='completed';
        a.completedAt=new Date().toISOString();
        save();closeModal();render();updateStats();renderAteliers();toast('Atelier cl√¥tur√©');
    }
    
    function deleteAtelier(id){
        if(!confirm('Supprimer cet atelier ?'))return;
        data.ateliers=data.ateliers.filter(x=>x.id!==id);
        save();updateStats();renderAteliers();toast('Atelier supprim√©');
    }
    
    // === SYNC ===
    function exportJSON(){
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`cellules_${new Date().toISOString().split('T')[0]}.json`;a.click();
        toast('üì¶ Export√©');
    }
    
    function copyJSON(){
        navigator.clipboard.writeText(JSON.stringify(data,null,2)).then(()=>toast('üìã Copi√© dans le presse-papier'));
    }
    
    function importJSON(){
        try{
            const text=document.getElementById('import-json').value;
            const imported=JSON.parse(text);
            let nc=0,na=0;
            (imported.cellules||[]).forEach(c=>{if(!data.cellules.some(x=>x.id===c.id)){data.cellules.push(c);nc++;}});
            (imported.ateliers||[]).forEach(a=>{if(!data.ateliers.some(x=>x.id===a.id)){data.ateliers.push(a);na++;}});
            save();render();updateStats();renderWorkstation();
            toast(`‚úÖ ${nc} cellule(s), ${na} atelier(s) import√©(s)`);
        }catch(e){toast('‚ùå JSON invalide');}
    }
    
    function resetData(){
        if(!confirm('R√©initialiser toutes les donn√©es ?'))return;
        localStorage.removeItem(KEY);
        location.reload();
    }
    
    function changeUser(){
        const newUser=prompt('Nouveau pseudo :',user);
        if(!newUser||!newUser.trim())return;
        user=newUser.trim();
        localStorage.setItem('cellules_user',user);
        renderWorkstation();
        toast('Pseudo chang√©');
    }
    
    // === MODAL ===
    function openModal(title,body){
        document.getElementById('modal-title').textContent=title;
        document.getElementById('modal-body').innerHTML=body;
        document.getElementById('modal').classList.add('open');
    }
    function closeModal(){document.getElementById('modal').classList.remove('open');}
    document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')closeModal();});
    
    // === UTILS ===
    function dist(lat1,lon1,lat2,lon2){const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
    function updateStats(){document.getElementById('stat-c').textContent=data.cellules.length;document.getElementById('stat-p').textContent=data.cellules.reduce((s,c)=>s+c.participants.length,0);document.getElementById('stat-a').textContent=data.ateliers.filter(a=>a.status!=='completed').length;}
    function toast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),3000);}
    
    boot();
    </script>
</body>
</html>
