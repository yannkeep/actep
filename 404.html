<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cellules Citoyennes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,system-ui,sans-serif; background:#030308; color:#fff; min-height:100vh; overflow:hidden; }
        
        /* === ONBOARDING === */
        #onboarding { position:fixed; inset:0; background:radial-gradient(ellipse at 50% 30%, #0a0a18 0%, #030308 70%); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem; text-align:center; }
        #onboarding.hidden { display:none; }
        #onboarding .glow-logo { font-size:5rem; margin-bottom:1rem; animation:logo-pulse 2s ease-in-out infinite; filter:drop-shadow(0 0 30px rgba(0,255,157,0.8)); }
        @keyframes logo-pulse { 0%,100%{transform:scale(1);filter:drop-shadow(0 0 20px rgba(0,255,157,0.6));} 50%{transform:scale(1.05);filter:drop-shadow(0 0 40px rgba(0,255,157,1));} }
        #onboarding h1 { font-family:'Orbitron',sans-serif; font-size:1.8rem; background:linear-gradient(135deg,#00ff9d,#00d4ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.5rem; }
        #onboarding p { color:#555; max-width:320px; line-height:1.6; margin-bottom:2rem; }
        #onboarding .steps { display:flex; gap:1.5rem; margin-bottom:2rem; }
        #onboarding .step { text-align:center; }
        #onboarding .step-icon { font-size:1.8rem; margin-bottom:0.4rem; }
        #onboarding .step-text { font-size:0.65rem; color:#444; }
        #onboarding input { width:100%; max-width:280px; padding:1rem; background:rgba(255,255,255,0.03); border:1px solid #1a1a2a; border-radius:0.5rem; color:#fff; font-size:1rem; margin-bottom:1rem; text-align:center; }
        #onboarding input:focus { outline:none; border-color:#00ff9d; box-shadow:0 0 30px rgba(0,255,157,0.15); }
        #onboarding input::placeholder { color:#333; }
        #onboarding button { background:linear-gradient(135deg,#00ff9d,#00d4ff); color:#000; border:none; padding:1rem 3rem; font-size:1rem; font-weight:700; cursor:pointer; border-radius:2rem; }
        #onboarding button:hover { box-shadow:0 0 50px rgba(0,255,157,0.6); transform:scale(1.02); }
        #onboarding .err { color:#ff3366; font-size:0.8rem; display:none; margin-bottom:1rem; }
        
        /* === APP === */
        #app { display:none; height:100vh; flex-direction:column; }
        #app.active { display:flex; }
        
        /* === HEADER === */
        header { background:rgba(8,8,15,0.95); backdrop-filter:blur(10px); padding:0.75rem 1.25rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,255,157,0.08); z-index:100; }
        .logo { font-family:'Orbitron',sans-serif; font-weight:700; font-size:1rem; color:#00ff9d; display:flex; align-items:center; gap:0.5rem; }
        .logo span { filter:drop-shadow(0 0 8px rgba(0,255,157,0.8)); }
        .stats { display:flex; gap:1.5rem; }
        .stat { text-align:center; }
        .stat-val { font-family:'Orbitron',sans-serif; font-weight:700; font-size:1.1rem; color:#00ff9d; text-shadow:0 0 10px rgba(0,255,157,0.5); }
        .stat-lbl { font-size:0.55rem; color:#444; text-transform:uppercase; }
        .menu-btn { display:none; background:rgba(0,255,157,0.1); border:1px solid rgba(0,255,157,0.2); color:#00ff9d; padding:0.5rem 0.75rem; cursor:pointer; }
        @media(max-width:800px) { .menu-btn { display:block; } }
        
        /* === MAIN === */
        main { flex:1; display:flex; position:relative; overflow:hidden; }
        
        /* === MAP === */
        #map-wrap { flex:1; position:relative; }
        #map { width:100%; height:100%; background:#030308; }
        .leaflet-tile-pane { filter:saturate(0) brightness(0.2) contrast(1.5); }
        .leaflet-control-zoom { border:none !important; margin-right:1rem !important; margin-bottom:1rem !important; }
        .leaflet-control-zoom a { background:rgba(8,8,15,0.9) !important; color:#00ff9d !important; border:1px solid rgba(0,255,157,0.2) !important; }
        
        /* === GLOW CANVAS === */
        #glow-canvas { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:350; mix-blend-mode:screen; }
        
        /* === CONTROLS === */
        .locate-btn { position:absolute; top:1rem; right:1rem; z-index:500; width:44px; height:44px; background:rgba(8,8,15,0.9); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.08); border-radius:50%; color:#fff; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .locate-btn:hover { border-color:#00ff9d; color:#00ff9d; box-shadow:0 0 20px rgba(0,255,157,0.3); }
        
        .map-controls { position:absolute; bottom:1.5rem; left:1rem; z-index:500; display:flex; gap:0.5rem; }
        .map-btn { background:rgba(8,8,15,0.9); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.08); color:#666; padding:0.6rem 1rem; font-size:0.75rem; cursor:pointer; border-radius:2rem; display:flex; align-items:center; gap:0.4rem; transition:all 0.3s; }
        .map-btn:hover { border-color:rgba(0,255,157,0.3); color:#00ff9d; }
        .map-btn.active { background:linear-gradient(135deg,#00ff9d,#00d4ff); color:#000; border:none; font-weight:600; }
        
        .fab { position:absolute; bottom:1.5rem; right:1rem; z-index:500; width:60px; height:60px; background:linear-gradient(135deg,#00ff9d,#00d4ff); border:none; border-radius:50%; font-size:2rem; color:#000; cursor:pointer; box-shadow:0 4px 30px rgba(0,255,157,0.5); display:flex; align-items:center; justify-content:center; }
        .fab:hover { transform:scale(1.1) rotate(90deg); box-shadow:0 0 60px rgba(0,255,157,0.8); }
        
        /* === LEGEND === */
        .legend { position:absolute; top:1rem; left:1rem; z-index:500; background:rgba(8,8,15,0.9); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.08); padding:0.75rem 1rem; border-radius:0.5rem; font-size:0.65rem; }
        .legend-title { font-family:'Orbitron',sans-serif; font-size:0.55rem; color:#00d4ff; margin-bottom:0.5rem; letter-spacing:0.1em; }
        .legend-item { display:flex; align-items:center; gap:0.5rem; color:#555; margin-bottom:0.25rem; }
        .legend-dot { width:10px; height:10px; border-radius:50%; }
        
        /* === SIDEBAR === */
        #sidebar { width:380px; background:rgba(8,8,15,0.98); backdrop-filter:blur(20px); border-left:1px solid rgba(0,255,157,0.05); display:flex; flex-direction:column; }
        @media(max-width:800px) { #sidebar { position:fixed; top:0; right:0; bottom:0; width:100%; transform:translateX(100%); transition:transform 0.3s; z-index:1000; } #sidebar.open { transform:translateX(0); } }
        .sidebar-header { padding:1.25rem; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; }
        .sidebar-title { font-family:'Orbitron',sans-serif; font-weight:500; font-size:0.8rem; color:#00ff9d; }
        .sidebar-close { display:none; background:none; border:none; color:#555; font-size:1.5rem; cursor:pointer; }
        @media(max-width:800px) { .sidebar-close { display:block; } }
        .sidebar-body { flex:1; overflow-y:auto; padding:1rem; }
        
        /* === CARDS === */
        .card { background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05); border-radius:0.5rem; padding:0.85rem; margin-bottom:0.6rem; cursor:pointer; transition:all 0.3s; position:relative; }
        .card::after { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg, var(--c, #00ff9d), transparent); opacity:0; transition:opacity 0.3s; border-radius:2px 2px 0 0; }
        .card:hover { border-color:var(--c, rgba(0,255,157,0.3)); transform:translateX(4px); }
        .card:hover::after { opacity:1; }
        .card-title { font-weight:600; font-size:0.85rem; margin-bottom:0.3rem; display:flex; align-items:center; gap:0.5rem; }
        .card-meta { font-size:0.7rem; color:#444; }
        
        .badge { font-size:0.5rem; padding:0.2rem 0.5rem; border-radius:1rem; font-weight:600; text-transform:uppercase; letter-spacing:0.03em; margin-left:auto; }
        .badge-y { background:rgba(255,234,0,0.15); color:#ffea00; }
        .badge-g { background:rgba(0,255,157,0.15); color:#00ff9d; }
        .badge-b { background:rgba(0,212,255,0.15); color:#00d4ff; animation:pulse-badge 1.5s infinite; }
        .badge-p { background:rgba(255,0,128,0.15); color:#ff0080; }
        @keyframes pulse-badge { 0%,100%{box-shadow:0 0 5px rgba(0,212,255,0.3);} 50%{box-shadow:0 0 15px rgba(0,212,255,0.6);} }
        
        .progress { height:3px; background:rgba(255,255,255,0.05); border-radius:2px; margin-top:0.6rem; overflow:hidden; }
        .progress-fill { height:100%; border-radius:2px; }
        
        /* === FORMS === */
        .form-group { margin-bottom:1.1rem; }
        .form-label { display:block; font-size:0.65rem; color:#555; margin-bottom:0.3rem; text-transform:uppercase; letter-spacing:0.05em; }
        .form-input { width:100%; padding:0.8rem; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:0.4rem; color:#fff; font-size:0.85rem; }
        .form-input:focus { outline:none; border-color:rgba(0,255,157,0.4); }
        select.form-input { cursor:pointer; }
        textarea.form-input { min-height:80px; resize:vertical; font-family:inherit; }
        
        .btn { padding:0.8rem 1.5rem; border:none; font-size:0.8rem; font-weight:600; cursor:pointer; width:100%; border-radius:0.4rem; transition:all 0.3s; }
        .btn-primary { background:linear-gradient(135deg,#00ff9d,#00d4ff); color:#000; }
        .btn-primary:hover { box-shadow:0 0 30px rgba(0,255,157,0.5); }
        .btn-secondary { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); color:#666; }
        .btn-secondary:hover { border-color:rgba(0,255,157,0.3); color:#00ff9d; }
        .btn-back { background:transparent; border:1px solid rgba(255,255,255,0.08); color:#555; margin-bottom:1.25rem; font-size:0.75rem; }
        .btn-group { display:flex; gap:0.6rem; margin-top:1.25rem; }
        .btn-group .btn { flex:1; }
        
        /* === DETAIL === */
        .detail-header { margin-bottom:1.25rem; }
        .detail-title { font-family:'Orbitron',sans-serif; font-size:1.2rem; font-weight:500; margin-bottom:0.4rem; }
        .detail-meta { font-size:0.75rem; color:#444; }
        .detail-desc { font-size:0.8rem; color:#666; line-height:1.6; margin-top:0.75rem; padding:0.75rem; background:rgba(255,255,255,0.02); border-radius:0.4rem; border-left:2px solid var(--c, #00ff9d); }
        .section-title { font-family:'Orbitron',sans-serif; font-size:0.6rem; color:#00d4ff; margin:1.25rem 0 0.75rem; letter-spacing:0.1em; }
        .participant { display:flex; justify-content:space-between; padding:0.5rem 0; font-size:0.8rem; border-bottom:1px solid rgba(255,255,255,0.03); }
        .participant:last-child { border:none; }
        
        /* === TOAST === */
        #toast { position:fixed; bottom:-80px; left:50%; transform:translateX(-50%); background:rgba(8,8,15,0.95); border:1px solid rgba(0,255,157,0.3); padding:0.85rem 1.75rem; border-radius:2rem; z-index:9999; transition:bottom 0.4s cubic-bezier(0.68,-0.55,0.265,1.55); font-size:0.85rem; backdrop-filter:blur(10px); }
        #toast.show { bottom:2rem; }
        
        ::-webkit-scrollbar { width:5px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:rgba(0,255,157,0.2); border-radius:3px; }
    </style>
</head>
<body>
    <div id="onboarding">
        <div class="glow-logo">‚ö°</div>
        <h1>Cellules Citoyennes</h1>
        <p>Cr√©ez des groupes de veille citoyenne et lancez des ateliers d'intelligence collective sur votre territoire.</p>
        <div class="steps">
            <div class="step"><div class="step-icon">üìç</div><div class="step-text">Choisissez un lieu</div></div>
            <div class="step"><div class="step-icon">üë•</div><div class="step-text">5 √† 9 personnes</div></div>
            <div class="step"><div class="step-icon">üí¨</div><div class="step-text">Lancez un atelier</div></div>
        </div>
        <input type="text" id="pseudo-input" placeholder="Votre pseudo" autofocus>
        <div class="err" id="err">Entrez un pseudo</div>
        <button onclick="enterApp()">Commencer</button>
    </div>

    <div id="app">
        <header>
            <div class="logo"><span>‚ö°</span> Cellules</div>
            <div class="stats">
                <div class="stat"><div class="stat-val" id="stat-c">0</div><div class="stat-lbl">Cellules</div></div>
                <div class="stat"><div class="stat-val" id="stat-p">0</div><div class="stat-lbl">Citoyens</div></div>
            </div>
            <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        </header>
        <main>
            <div id="map-wrap">
                <div id="map"></div>
                <canvas id="glow-canvas"></canvas>
                <div class="legend">
                    <div class="legend-title">TERRITOIRES</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ffea00;box-shadow:0 0 6px #ffea00;"></div> Recrutement</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00ff9d;box-shadow:0 0 6px #00ff9d;"></div> Active</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00d4ff;box-shadow:0 0 10px #00d4ff;"></div> Atelier</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ff0080;box-shadow:0 0 6px #ff0080;"></div> Antenne</div>
                </div>
                <button class="locate-btn" onclick="locate()">üìç</button>
                <div class="map-controls">
                    <button class="map-btn active" id="btn-zones" onclick="toggleZones()">‚óê Zones</button>
                    <button class="map-btn active" id="btn-links" onclick="toggleLinks()">‚üÅ R√©seau</button>
                </div>
                <button class="fab" onclick="openCreate()">+</button>
            </div>
            <aside id="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title" id="sidebar-title">Cellules</span>
                    <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
                </div>
                <div class="sidebar-body" id="sidebar-body"></div>
            </aside>
        </main>
    </div>
    <div id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    const KEY='cellules_v3', THEMES={
        mobilite:{e:'üö≤',l:'Mobilit√©',c:'#00ff9d'},
        environnement:{e:'üå±',l:'Environnement',c:'#22cc77'},
        social:{e:'ü§ù',l:'Social',c:'#ff9d00'},
        numerique:{e:'üíª',l:'Num√©rique',c:'#00d4ff'},
        culture:{e:'üé≠',l:'Culture',c:'#ff00ff'},
        economie:{e:'üíº',l:'√âconomie',c:'#ffea00'},
        democratie:{e:'üó≥Ô∏è',l:'D√©mocratie',c:'#ff3366'},
        education:{e:'üìö',l:'√âducation',c:'#9d00ff'},
        sante:{e:'üè•',l:'Sant√©',c:'#00ffcc'},
        autre:{e:'üìã',l:'Autre',c:'#888'}
    }, SEEDS=[
        {id:'s1',lat:50.8466,lon:4.3528,title:'Antenne Bruxelles',theme:'democratie',desc:'Point de ralliement Bruxelles',radius:12},
        {id:'s2',lat:50.4669,lon:4.8675,title:'Antenne Namur',theme:'democratie',desc:'Point de ralliement Namur',radius:15},
        {id:'s3',lat:50.6326,lon:5.5797,title:'Antenne Li√®ge',theme:'social',desc:'Point de ralliement Li√®ge',radius:12},
        {id:'s4',lat:50.4108,lon:4.4446,title:'Antenne Charleroi',theme:'social',desc:'Point de ralliement Charleroi',radius:10},
        {id:'s5',lat:50.4542,lon:3.9523,title:'Antenne Mons',theme:'culture',desc:'Point de ralliement Mons',radius:10}
    ];
    
    let map,layers={},data,user,userPos,clickedPos,showZones=true,showLinks=true,glowCanvas,glowCtx;
    
    function boot(){user=localStorage.getItem('cellules_user');data=load();if(user)startApp();}
    function load(){const s=localStorage.getItem(KEY);if(s)return JSON.parse(s);const d={cellules:SEEDS.map(s=>({...s,seed:true,creator:'R√©seau',participants:[{name:'R√©seau',role:'seed'}],min:5,max:15})),ateliers:[]};localStorage.setItem(KEY,JSON.stringify(d));return d;}
    function save(){localStorage.setItem(KEY,JSON.stringify(data));}
    
    function enterApp(){const i=document.getElementById('pseudo-input'),e=document.getElementById('err'),p=i.value.trim();if(!p){e.style.display='block';i.focus();return;}user=p;localStorage.setItem('cellules_user',p);startApp();}
    function startApp(){document.getElementById('onboarding').classList.add('hidden');document.getElementById('app').classList.add('active');if(typeof L==='undefined'){setTimeout(startApp,100);return;}initMap();initGlow();}
    
    function initMap(){
        map=L.map('map',{center:[50.5,4.5],zoom:8,zoomControl:false});
        L.control.zoom({position:'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);
        layers.zones=L.layerGroup().addTo(map);
        layers.links=L.layerGroup().addTo(map);
        layers.markers=L.layerGroup().addTo(map);
        map.on('click',e=>{clickedPos={lat:e.latlng.lat,lon:e.latlng.lng};openCreate();});
        map.on('moveend zoomend',renderGlow);
        render();renderList();updateStats();locate();
    }
    
    function render(){
        layers.zones.clearLayers();layers.links.clearLayers();layers.markers.clearLayers();
        
        // ZONES
        if(showZones){
            data.cellules.forEach(c=>{
                const t=THEMES[c.theme]||THEMES.autre,r=(c.radius||5)*1000,n=c.participants.length,rdy=n>=(c.min||5),atl=data.ateliers.some(a=>a.celluleId===c.id);
                
                // Outer glow
                L.circle([c.lat,c.lon],{radius:r*1.8,color:'transparent',fillColor:t.c,fillOpacity:0.015,weight:0}).addTo(layers.zones);
                
                // Main zone
                L.circle([c.lat,c.lon],{radius:r,color:t.c,fillColor:t.c,fillOpacity:rdy?0.08:0.03,weight:rdy?2:1,opacity:rdy?0.5:0.2,dashArray:rdy?null:'8,8'}).addTo(layers.zones);
                
                // Inner core
                if(rdy){
                    L.circle([c.lat,c.lon],{radius:r*0.25,color:t.c,fillColor:t.c,fillOpacity:0.2,weight:1,opacity:0.7}).addTo(layers.zones);
                }
                
                // Atelier ring
                if(atl){
                    L.circle([c.lat,c.lon],{radius:r*1.2,color:'#00d4ff',fillColor:'transparent',fillOpacity:0,weight:2,opacity:0.4,dashArray:'4,8'}).addTo(layers.zones);
                }
            });
        }
        
        // LINKS
        if(showLinks){
            const active=data.cellules.filter(c=>c.participants.length>=5);
            active.forEach((a,i)=>{
                active.slice(i+1).forEach(b=>{
                    const d=dist(a.lat,a.lon,b.lat,b.lon);
                    if(d<40){
                        const ca=THEMES[a.theme]?.c||'#00d4ff',cb=THEMES[b.theme]?.c||'#00d4ff',w=Math.max(1,4-d/12),o=Math.max(0.1,0.5-d/80);
                        // Glow line
                        L.polyline([[a.lat,a.lon],[b.lat,b.lon]],{color:ca,weight:w*3,opacity:o*0.2,lineCap:'round'}).addTo(layers.links);
                        // Main line
                        L.polyline([[a.lat,a.lon],[b.lat,b.lon]],{color:cb,weight:w,opacity:o,lineCap:'round',dashArray:'6,12'}).addTo(layers.links);
                    }
                });
            });
        }
        
        // MARKERS
        data.cellules.forEach(c=>{
            const t=THEMES[c.theme]||THEMES.autre,n=c.participants.length,rdy=n>=(c.min||5),atl=data.ateliers.some(a=>a.celluleId===c.id),sz=Math.min(18,7+n*1.5);
            let col='#ffea00';if(rdy)col='#00ff9d';if(atl)col='#00d4ff';if(c.seed)col='#ff0080';
            
            // Glow
            if(rdy||atl){L.circleMarker([c.lat,c.lon],{radius:sz+10,color:'transparent',fillColor:col,fillOpacity:atl?0.25:0.12,weight:0}).addTo(layers.markers);}
            
            // Marker
            const m=L.circleMarker([c.lat,c.lon],{radius:sz,color:'#fff',fillColor:col,fillOpacity:1,weight:2,opacity:0.9});
            m.on('click',e=>{L.DomEvent.stopPropagation(e);showDetail(c.id);});
            m.bindTooltip(`<b style="color:${t.c}">${t.e} ${c.title}</b><br><span style="color:#888">${n} participant${n>1?'s':''}</span>`,{direction:'top',offset:[0,-sz]});
            m.addTo(layers.markers);
        });
        
        renderGlow();
    }
    
    // GLOW CANVAS
    function initGlow(){
        glowCanvas=document.getElementById('glow-canvas');glowCtx=glowCanvas.getContext('2d');
        resizeGlow();window.addEventListener('resize',resizeGlow);animateGlow();
    }
    function resizeGlow(){const w=document.getElementById('map-wrap');glowCanvas.width=w.offsetWidth;glowCanvas.height=w.offsetHeight;renderGlow();}
    function renderGlow(){
        if(!glowCtx||!map)return;
        glowCtx.clearRect(0,0,glowCanvas.width,glowCanvas.height);
        
        data.cellules.forEach(c=>{
            const atl=data.ateliers.some(a=>a.celluleId===c.id);
            if(!atl)return;
            
            const pt=map.latLngToContainerPoint([c.lat,c.lon]),t=THEMES[c.theme]||THEMES.autre,col=t.c;
            const time=Date.now()/1000,pulse=0.6+0.4*Math.sin(time*2),rad=50*pulse;
            
            const g=glowCtx.createRadialGradient(pt.x,pt.y,0,pt.x,pt.y,rad);
            g.addColorStop(0,col+'60');g.addColorStop(0.4,col+'25');g.addColorStop(1,'transparent');
            glowCtx.fillStyle=g;glowCtx.beginPath();glowCtx.arc(pt.x,pt.y,rad,0,Math.PI*2);glowCtx.fill();
        });
    }
    function animateGlow(){renderGlow();requestAnimationFrame(animateGlow);}
    
    function locate(){if(!navigator.geolocation)return;navigator.geolocation.getCurrentPosition(p=>{userPos={lat:p.coords.latitude,lon:p.coords.longitude};map.setView([userPos.lat,userPos.lon],10);renderList();},()=>map.setView([50.5,4.5],8));}
    function toggleZones(){showZones=!showZones;document.getElementById('btn-zones').classList.toggle('active',showZones);render();}
    function toggleLinks(){showLinks=!showLinks;document.getElementById('btn-links').classList.toggle('active',showLinks);render();}
    function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}
    
    // SIDEBAR
    function renderList(){
        document.getElementById('sidebar-title').textContent='Cellules';
        let list=[...data.cellules];
        if(userPos)list=list.map(c=>({...c,d:dist(userPos.lat,userPos.lon,c.lat,c.lon)})).sort((a,b)=>a.d-b.d);
        
        let h='';
        list.forEach(c=>{
            const t=THEMES[c.theme]||THEMES.autre,n=c.participants.length,pct=(n/(c.max||9))*100,rdy=n>=(c.min||5),atl=data.ateliers.some(a=>a.celluleId===c.id);
            let bdg=c.seed?'<span class="badge badge-p">Antenne</span>':atl?'<span class="badge badge-b">Live</span>':rdy?'<span class="badge badge-g">Active</span>':'<span class="badge badge-y">Recrute</span>';
            h+=`<div class="card" style="--c:${t.c}" onclick="showDetail('${c.id}')"><div class="card-title">${t.e} ${c.title}${bdg}</div><div class="card-meta">${n}/${c.max||9}${c.d?' ¬∑ '+c.d.toFixed(1)+' km':''}</div><div class="progress"><div class="progress-fill" style="width:${pct}%;background:linear-gradient(90deg,${t.c},${t.c}88);"></div></div></div>`;
        });
        h+=`<div class="btn-group"><button class="btn btn-secondary" onclick="exportData()">üì§ Export</button><button class="btn btn-secondary" onclick="importData()">üì• Import</button></div>`;
        document.getElementById('sidebar-body').innerHTML=h;
    }
    
    function showDetail(id){
        const c=data.cellules.find(x=>x.id===id);if(!c)return;
        map.setView([c.lat,c.lon],12);document.getElementById('sidebar').classList.add('open');document.getElementById('sidebar-title').textContent='D√©tail';
        
        const t=THEMES[c.theme]||THEMES.autre,n=c.participants.length,rdy=n>=(c.min||5),pct=(n/(c.max||9))*100,isMember=c.participants.some(p=>p.name===user),atl=data.ateliers.find(a=>a.celluleId===c.id);
        
        let h=`<button class="btn btn-back" onclick="renderList()">‚Üê Retour</button>
        <div class="detail-header"><div class="detail-title" style="color:${t.c}">${t.e} ${c.title}</div><div class="detail-meta">${t.l} ¬∑ par ${c.creator}</div>${c.desc?`<div class="detail-desc" style="--c:${t.c}">${c.desc}</div>`:''}</div>
        <div class="section-title">PARTICIPANTS (${n}/${c.max||9})</div>
        <div class="progress" style="margin-bottom:1rem;"><div class="progress-fill" style="width:${pct}%;background:linear-gradient(90deg,${t.c},${t.c}88);"></div></div>`;
        
        c.participants.forEach((p,i)=>{const me=p.name===user,cr=i===0||p.role==='seed';h+=`<div class="participant"><span style="color:${cr?'#00ff9d':me?'#00d4ff':'#888'}">${cr?'üëë ':''}${p.name}${me?' (vous)':''}</span></div>`;});
        
        if(!isMember&&n<(c.max||9))h+=`<button class="btn btn-primary" style="margin-top:1rem;" onclick="join('${c.id}')">Rejoindre</button>`;
        else if(isMember&&!c.seed&&c.participants.findIndex(p=>p.name===user)>0)h+=`<button class="btn btn-secondary" style="margin-top:1rem;" onclick="leave('${c.id}')">Quitter</button>`;
        
        if(rdy){
            h+=`<div class="section-title">ATELIER</div>`;
            if(atl)h+=`<div style="padding:0.75rem;background:rgba(0,212,255,0.1);border-radius:0.4rem;border:1px solid rgba(0,212,255,0.2);"><div style="color:#00d4ff;font-weight:600;">üìã ${atl.title}</div><div style="font-size:0.75rem;color:#555;margin-top:0.25rem;">Statut: ${atl.status==='live'?'üî¥ Live':'‚è≥ Async'}</div></div>`;
            else if(isMember){h+=`<div style="padding:0.75rem;background:rgba(0,255,157,0.1);border-radius:0.4rem;border:1px solid rgba(0,255,157,0.2);margin-bottom:0.75rem;"><div style="color:#00ff9d;font-weight:600;">‚úÖ Quorum atteint !</div></div>`;h+=`<button class="btn btn-primary" onclick="launchAtelier('${c.id}')">üöÄ Lancer un atelier</button>`;}
        }
        
        const matches=data.cellules.filter(x=>x.id!==c.id&&x.participants.length>=5).map(x=>({...x,d:dist(c.lat,c.lon,x.lat,x.lon)})).filter(x=>x.d<30).sort((a,b)=>a.d-b.d).slice(0,3);
        if(matches.length){h+=`<div class="section-title">CELLULES CONNECT√âES</div>`;matches.forEach(m=>{const mt=THEMES[m.theme]||THEMES.autre;h+=`<div class="card" style="--c:${mt.c}" onclick="showDetail('${m.id}')"><div class="card-title">${mt.e} ${m.title}</div><div class="card-meta">${m.d.toFixed(1)} km ¬∑ ${m.participants.length} pers.</div></div>`;});}
        
        document.getElementById('sidebar-body').innerHTML=h;
    }
    
    // CREATE
    function openCreate(){
        const pos=clickedPos||userPos||{lat:50.5,lon:4.5};document.getElementById('sidebar').classList.add('open');document.getElementById('sidebar-title').textContent='Nouvelle';
        let opts=Object.entries(THEMES).map(([k,v])=>`<option value="${k}">${v.e} ${v.l}</option>`).join('');
        document.getElementById('sidebar-body').innerHTML=`<button class="btn btn-back" onclick="renderList()">‚Üê Annuler</button>
        <div class="form-group"><label class="form-label">Titre</label><input class="form-input" id="f-title" placeholder="Ex: V√©lo-√©cole Ixelles"></div>
        <div class="form-group"><label class="form-label">Th√©matique</label><select class="form-input" id="f-theme"><option value="">Choisir...</option>${opts}</select></div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="f-desc" placeholder="D√©crivez votre cellule..."></textarea></div>
        <div class="form-group"><label class="form-label">Rayon (km)</label><input type="number" class="form-input" id="f-radius" value="5" min="1" max="20"></div>
        <div style="color:#444;font-size:0.7rem;margin-bottom:1rem;text-align:center;">üìç ${pos.lat.toFixed(4)}, ${pos.lon.toFixed(4)}</div>
        <button class="btn btn-primary" onclick="create(${pos.lat},${pos.lon})">Cr√©er</button>`;
    }
    
    function create(lat,lon){
        const title=document.getElementById('f-title').value.trim(),theme=document.getElementById('f-theme').value,desc=document.getElementById('f-desc').value.trim(),radius=parseFloat(document.getElementById('f-radius').value)||5;
        if(!title||!theme){toast('Titre et th√©matique requis');return;}
        const c={id:'c'+Date.now(),lat,lon,title,theme,desc,radius,creator:user,participants:[{name:user,role:'creator'}],min:5,max:9};
        data.cellules.push(c);save();clickedPos=null;render();updateStats();showDetail(c.id);toast('Cellule cr√©√©e !');
    }
    
    // ACTIONS
    function join(id){const c=data.cellules.find(x=>x.id===id);if(!c||c.participants.some(p=>p.name===user))return;if(c.participants.length>=(c.max||9)){toast('Compl√®te');return;}c.participants.push({name:user});save();render();updateStats();showDetail(id);toast(c.participants.length>=(c.min||5)?'üéâ Quorum !':'Bienvenue !');}
    function leave(id){const c=data.cellules.find(x=>x.id===id);if(!c)return;const i=c.participants.findIndex(p=>p.name===user);if(i<=0)return;c.participants.splice(i,1);save();render();updateStats();renderList();toast('Quitt√©');}
    function launchAtelier(id){const title=prompt('Titre:','Atelier');if(!title)return;data.ateliers.push({id:'a'+Date.now(),celluleId:id,title,status:'async',startedAt:new Date().toISOString()});save();render();showDetail(id);toast('üöÄ Lanc√© !');}
    
    // SYNC
    function exportData(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));a.download='cellules.json';a.click();toast('Export√©');}
    function importData(){const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);let n=0;(d.cellules||[]).forEach(c=>{if(!data.cellules.some(x=>x.id===c.id)){data.cellules.push(c);n++;}});(d.ateliers||[]).forEach(a=>{if(!data.ateliers.some(x=>x.id===a.id))data.ateliers.push(a);});save();render();renderList();updateStats();toast(`${n} import√©e(s)`);}catch(e){toast('Invalide');}};r.readAsText(e.target.files[0]);};i.click();}
    
    function dist(lat1,lon1,lat2,lon2){const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
    function updateStats(){document.getElementById('stat-c').textContent=data.cellules.length;document.getElementById('stat-p').textContent=data.cellules.reduce((s,c)=>s+c.participants.length,0);}
    function toast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),3000);}
    
    boot();
    </script>
</body>
</html>
