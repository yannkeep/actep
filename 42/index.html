<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° CELLULES CITOYENNES</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --void:#000; --dark:#0a0a0f; --mid:#111; --green:#00ff9d; --blue:#00d4ff; --pink:#ff0080; --yellow:#ffea00; --red:#ff3366; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Share Tech Mono',monospace; background:var(--void); color:#fff; height:100vh; overflow:hidden; }
        
        /* LAYOUT */
        .app { display:grid; grid-template-columns:1fr 360px; height:100vh; }
        @media(max-width:800px) { 
            .app { grid-template-columns:1fr; }
            .sidebar { position:fixed; top:0; right:-100%; width:100%; height:100%; transition:right 0.3s; z-index:1000; }
            .sidebar.open { right:0; }
        }
        
        /* MAP */
        .map-area { position:relative; }
        #map { width:100%; height:100%; }
        .leaflet-container { background:#000; }
        .leaflet-tile-pane { filter:saturate(0.1) brightness(0.25) contrast(1.5); }
        
        /* MAP HEADER */
        .map-header { position:absolute; top:0; left:0; right:0; z-index:500; background:linear-gradient(180deg,rgba(0,0,0,0.9) 0%,transparent 100%); padding:1rem; display:flex; justify-content:space-between; align-items:flex-start; pointer-events:none; }
        .map-header > * { pointer-events:auto; }
        .logo { font-family:'Orbitron'; font-size:1rem; color:var(--green); text-shadow:0 0 15px var(--green); }
        .logo small { font-size:0.5rem; color:var(--pink); background:rgba(255,0,128,0.2); padding:0.1rem 0.3rem; margin-left:0.5rem; }
        .stats { display:flex; gap:1.5rem; }
        .stat { text-align:center; }
        .stat-val { font-family:'Orbitron'; font-size:1.1rem; color:var(--green); }
        .stat-lbl { font-size:0.55rem; color:#666; }
        .mobile-open { display:none; background:var(--green); border:none; color:#000; width:40px; height:40px; font-size:1.2rem; cursor:pointer; }
        @media(max-width:800px) { .mobile-open { display:block; } }
        
        /* MAP CONTROLS */
        .map-controls { position:absolute; bottom:1rem; left:1rem; z-index:500; display:flex; gap:0.5rem; }
        .map-btn { display:flex; align-items:center; gap:0.4rem; background:var(--dark); border:1px solid #333; color:#888; padding:0.4rem 0.6rem; cursor:pointer; font-size:0.65rem; font-family:'Share Tech Mono'; transition:all 0.15s; }
        .map-btn:hover { border-color:var(--green); color:var(--green); }
        .map-btn.active { background:var(--green); color:#000; border-color:var(--green); }
        .map-locate { position:absolute; bottom:1rem; right:1rem; z-index:500; }
        .locate-btn { width:40px; height:40px; background:var(--dark); border:1px solid var(--green); color:var(--green); cursor:pointer; font-size:1.1rem; }
        .locate-btn:hover { background:var(--green); color:#000; }
        
        /* SIDEBAR */
        .sidebar { background:var(--dark); border-left:1px solid #222; display:flex; flex-direction:column; }
        .sidebar-header { padding:1rem; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center; }
        .sidebar-title { font-family:'Orbitron'; font-size:0.75rem; color:var(--green); }
        .sidebar-close { display:none; background:none; border:none; color:var(--pink); font-size:1.5rem; cursor:pointer; }
        @media(max-width:800px) { .sidebar-close { display:block; } }
        .sidebar-tabs { display:flex; border-bottom:1px solid #222; }
        .sidebar-tab { flex:1; padding:0.6rem; background:none; border:none; color:#555; cursor:pointer; font-size:0.65rem; font-family:'Share Tech Mono'; border-bottom:2px solid transparent; transition:all 0.15s; }
        .sidebar-tab:hover { color:#888; }
        .sidebar-tab.active { color:var(--green); border-bottom-color:var(--green); }
        .sidebar-content { flex:1; overflow-y:auto; }
        .sidebar-panel { display:none; padding:1rem; }
        .sidebar-panel.active { display:block; }
        
        /* COMPONENTS */
        .section { background:var(--mid); border:1px solid #333; padding:0.75rem; margin-bottom:0.75rem; }
        .section-title { font-family:'Orbitron'; font-size:0.6rem; color:var(--blue); margin-bottom:0.5rem; }
        .card { background:var(--mid); border:1px solid #333; padding:0.75rem; margin-bottom:0.5rem; cursor:pointer; transition:all 0.15s; }
        .card:hover { border-color:var(--green); transform:translateX(3px); }
        .card-header { display:flex; justify-content:space-between; align-items:flex-start; gap:0.5rem; }
        .card-title { font-family:'Orbitron'; font-size:0.75rem; color:var(--green); flex:1; }
        .card-meta { font-size:0.65rem; color:#666; margin-top:0.3rem; }
        .badge { font-size:0.5rem; padding:0.15rem 0.4rem; white-space:nowrap; }
        .badge-yellow { background:rgba(255,234,0,0.15); color:var(--yellow); border:1px solid var(--yellow); }
        .badge-green { background:rgba(0,255,157,0.15); color:var(--green); border:1px solid var(--green); }
        .badge-blue { background:rgba(0,212,255,0.15); color:var(--blue); border:1px solid var(--blue); }
        .progress { height:4px; background:#333; border-radius:2px; margin-top:0.5rem; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--green),var(--blue)); }
        .participant { display:flex; justify-content:space-between; align-items:center; padding:0.35rem 0; border-bottom:1px solid #222; font-size:0.75rem; }
        .participant:last-child { border:none; }
        .contribution { background:#0a0a0a; border-left:2px solid var(--blue); padding:0.5rem; margin-bottom:0.5rem; }
        .contribution-header { display:flex; justify-content:space-between; font-size:0.65rem; margin-bottom:0.3rem; }
        .contribution-author { color:var(--green); }
        .contribution-votes { color:var(--yellow); }
        .contribution-text { font-size:0.75rem; color:#ccc; line-height:1.4; }
        .timeline { margin:0.5rem 0; }
        .timeline-item { display:flex; gap:0.5rem; padding:0.35rem 0; }
        .timeline-dot { width:10px; height:10px; border-radius:50%; border:2px solid #333; flex-shrink:0; margin-top:2px; }
        .timeline-dot.done { background:var(--green); border-color:var(--green); }
        .timeline-dot.active { background:var(--blue); border-color:var(--blue); }
        .timeline-title { font-size:0.7rem; }
        .timeline-date { font-size:0.6rem; color:#555; }
        .match { display:flex; justify-content:space-between; align-items:center; padding:0.5rem; background:#0a0a0a; border:1px solid #222; margin-bottom:0.4rem; cursor:pointer; }
        .match:hover { border-color:var(--blue); }
        .match-score { font-family:'Orbitron'; font-size:0.9rem; color:var(--green); }
        
        /* FORMS */
        .form-group { margin-bottom:0.75rem; }
        .form-label { font-size:0.6rem; color:#666; margin-bottom:0.25rem; display:block; }
        .form-input { width:100%; font-family:'Share Tech Mono'; font-size:0.8rem; padding:0.5rem; background:#000; border:1px solid #333; color:#fff; }
        .form-input:focus { outline:none; border-color:var(--green); }
        textarea.form-input { min-height:70px; resize:vertical; }
        .btn { font-family:'Orbitron'; font-size:0.65rem; padding:0.5rem 1rem; border:none; cursor:pointer; transition:all 0.15s; }
        .btn-primary { background:var(--green); color:#000; }
        .btn-primary:hover { box-shadow:0 0 15px var(--green); }
        .btn-secondary { background:none; border:1px solid var(--blue); color:var(--blue); }
        .btn-secondary:hover { background:var(--blue); color:#000; }
        .btn-danger { background:none; border:1px solid var(--red); color:var(--red); }
        .btn-ghost { background:none; border:1px solid #333; color:#666; }
        .btn-ghost:hover { border-color:#888; color:#888; }
        .btn-block { width:100%; }
        .btn-group { display:flex; gap:0.5rem; margin-top:0.75rem; }
        
        /* TOAST */
        .toast { position:fixed; bottom:-60px; left:50%; transform:translateX(-50%); background:var(--dark); border:1px solid var(--green); padding:0.6rem 1.5rem; z-index:9999; transition:bottom 0.3s; font-size:0.75rem; }
        .toast.show { bottom:1.5rem; }
        .toast.error { border-color:var(--red); }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width:5px; }
        ::-webkit-scrollbar-track { background:var(--void); }
        ::-webkit-scrollbar-thumb { background:var(--green); }
        
        /* LEAFLET */
        .leaflet-popup-content-wrapper { background:var(--dark); color:#fff; border:1px solid var(--green); border-radius:0; }
        .leaflet-popup-tip { background:var(--dark); }
        .leaflet-popup-close-button { color:var(--pink)!important; }
    </style>
</head>
<body>
    <div class="app">
        <div class="map-area">
            <div id="map"></div>
            <div class="map-header">
                <div class="logo">‚ö° CELLULES CITOYENNES <small>D√âMO</small></div>
                <div class="stats">
                    <div class="stat"><div class="stat-val" id="stat-c">0</div><div class="stat-lbl">Cellules</div></div>
                    <div class="stat"><div class="stat-val" id="stat-p">0</div><div class="stat-lbl">Citoyens</div></div>
                    <div class="stat"><div class="stat-val" id="stat-a">0</div><div class="stat-lbl">Ateliers</div></div>
                </div>
                <button class="mobile-open" onclick="document.querySelector('.sidebar').classList.add('open')">‚ò∞</button>
            </div>
            <div class="map-controls">
                <button class="map-btn active" id="btn-links"><span>‚üÅ</span> R√©seau</button>
                <button class="map-btn" id="btn-zones"><span>‚óá</span> Zones</button>
            </div>
            <div class="map-locate"><button class="locate-btn" id="btn-locate">‚óé</button></div>
        </div>
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">EXPLORER</div>
                <button class="sidebar-close" onclick="document.querySelector('.sidebar').classList.remove('open')">√ó</button>
            </div>
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-panel="list">üìç Cellules</button>
                <button class="sidebar-tab" data-panel="ateliers">üìã Ateliers</button>
                <button class="sidebar-tab" data-panel="sync">üîÑ Sync</button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-panel active" id="panel-list"></div>
                <div class="sidebar-panel" id="panel-ateliers"></div>
                <div class="sidebar-panel" id="panel-sync"></div>
                <div class="sidebar-panel" id="panel-detail"></div>
                <div class="sidebar-panel" id="panel-create"></div>
            </div>
        </aside>
    </div>
    <div class="toast" id="toast"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    (function init() {
        if (typeof L === 'undefined') { setTimeout(init, 50); return; }
        
        // DATA
        const DEMO = {
            cellules: [
                { id:'c1', title:'V√©lo-√©cole Ixelles', theme:'mobilite', desc:'Apprendre √† circuler √† v√©lo en ville.', lat:50.8274, lon:4.3720, zone:'bxl', radius:3, creator:'MarieVelo', participants:[{name:'MarieVelo',role:'creator'},{name:'PierreBXL'},{name:'SophieMob'},{name:'Ahmed_M'},{name:'ClaraRoue'},{name:'YvesCyclo'},{name:'NadiaB'}], min:5, max:9 },
                { id:'c2', title:'Potager Schaerbeek', theme:'environnement', desc:'Cultiver ensemble, permaculture.', lat:50.8656, lon:4.3750, zone:'bxl', radius:2, creator:'GreenThumb', participants:[{name:'GreenThumb',role:'creator'},{name:'Jardinier42'},{name:'Permaculto'},{name:'SoleilVert'},{name:'TerreUrbaine'}], min:5, max:12 },
                { id:'c3', title:'Repair Caf√© Molenbeek', theme:'economie', desc:'R√©parer plut√¥t que jeter !', lat:50.8540, lon:4.3280, zone:'bxl', radius:4, creator:'FixItAll', participants:[{name:'FixItAll',role:'creator'},{name:'ElectroBen'},{name:'CoutureKim'},{name:'TechSam'}], min:5, max:9 },
                { id:'c4', title:'Alphab√©tisation num√©rique', theme:'numerique', desc:'Accompagner les seniors.', lat:50.8450, lon:4.3570, zone:'bxl', radius:5, creator:'DigiSenior', participants:[{name:'DigiSenior',role:'creator'},{name:'PatientPaul'},{name:'HelperHana'},{name:'TechTeach'},{name:'SeniorSoph'},{name:'DigitalDan'}], min:5, max:9 },
                { id:'c5', title:'Conseil citoyen Namur', theme:'democratie', desc:'Veille sur les d√©cisions communales.', lat:50.4669, lon:4.8620, zone:'wal', radius:8, creator:'CitoyenActif', participants:[{name:'CitoyenActif',role:'creator'},{name:'DemocrateJo'},{name:'VeilleCit'},{name:'NamurWatch'},{name:'ParticiPat'},{name:'ConseilCla'},{name:'CitizenNam'},{name:'DemosNamur'}], min:5, max:15 },
                { id:'c6', title:'FabLab Li√®ge', theme:'numerique', desc:'Imprimantes 3D, Arduino.', lat:50.6243, lon:5.5666, zone:'wal', radius:6, creator:'MakerLiege', participants:[{name:'MakerLiege',role:'creator'},{name:'3DPrintPro'},{name:'LaserLuc'},{name:'ArduinoAna'},{name:'ElectroniK'},{name:'DesignDave'}], min:5, max:12 },
                { id:'c7', title:'√âpicerie sociale Charleroi', theme:'social', desc:'Alimentation solidaire.', lat:50.4120, lon:4.4445, zone:'wal', radius:5, creator:'SolidaireCha', participants:[{name:'SolidaireCha',role:'creator'},{name:'EntraideEva'},{name:'PartageMax'},{name:'AntiGaspi'},{name:'SocialSam'},{name:'AidePaul'},{name:'EpicerieEm'}], min:5, max:15 },
                { id:'c8', title:'Th√©√¢tre-forum Mons', theme:'culture', desc:'Th√©√¢tre de l\'opprim√©.', lat:50.4531, lon:3.9519, zone:'wal', radius:7, creator:'SceneOuverte', participants:[{name:'SceneOuverte',role:'creator'},{name:'ActeurAlex'},{name:'ImprovIsa'}], min:6, max:12 },
                { id:'c9', title:'Sant√© communautaire LLN', theme:'sante', desc:'Pr√©vention, bien-√™tre.', lat:50.6696, lon:4.6157, zone:'wal', radius:4, creator:'SantePourTous', participants:[{name:'SantePourTous',role:'creator'},{name:'DocMarie'},{name:'YogaYann'},{name:'NutriNadia'},{name:'BienEtreBea'}], min:5, max:10 },
                { id:'c10', title:'√âcole citoyenne Verviers', theme:'education', desc:'Esprit critique, m√©dias.', lat:50.5887, lon:5.8660, zone:'wal', radius:5, creator:'EduPop', participants:[{name:'EduPop',role:'creator'},{name:'CritiqueCla'},{name:'DecryptoMax'},{name:'MediaWatch'},{name:'EcoExplain'},{name:'PedagoPhil'}], min:5, max:12 }
            ],
            ateliers: [
                { id:'a1', celluleId:'c1', title:'S√©curit√© v√©lo', status:'live', asyncStart:'2026-01-14', asyncEnd:'2026-01-28', liveStart:'2026-01-28', platforms:'Jitsi + Pad', contributions:[{author:'PierreBXL',text:'Cartographier les points noirs',votes:5},{author:'SophieMob',text:'Masse critique mensuelle',votes:7},{author:'MarieVelo',text:'Synth√®se : formation, plaidoyer, entraide',votes:8}] },
                { id:'a2', celluleId:'c5', title:'Budget participatif', status:'async', asyncStart:'2026-01-20', asyncEnd:'2026-02-03', liveStart:'2026-02-03', platforms:'Discord', contributions:[{author:'DemocrateJo',text:'Analyse budget 2025',votes:12},{author:'VeilleCit',text:'Comparaison r√©gionale',votes:8}] },
                { id:'a3', celluleId:'c6', title:'Recyclage PET', status:'completed', asyncStart:'2025-12-15', asyncEnd:'2025-12-29', outcomes:['Filament recycl√©','Broyeuse 800‚Ç¨','Partenariat Intradel'] }
            ]
        };
        
        const KEY = 'cellules_v3';
        const S = {
            data: JSON.parse(localStorage.getItem(KEY)) || JSON.parse(JSON.stringify(DEMO)),
            map: null, layers: {}, selected: null, selectedNode: null, showLinks: true, showZones: false
        };
        if (!localStorage.getItem(KEY)) localStorage.setItem(KEY, JSON.stringify(S.data));
        const save = () => localStorage.setItem(KEY, JSON.stringify(S.data));
        const genId = () => 'c' + Date.now().toString(36);
        
        // GRID
        const NODES = [];
        let i = 0;
        for (let lat = 50.78; lat <= 50.90; lat += 0.015)
            for (let lon = 4.28; lon <= 4.48; lon += 0.015)
                NODES.push({ id: 'n' + i++, lat, lon, zone: 'bxl' });
        for (let lat = 49.55; lat <= 50.75; lat += 0.06)
            for (let lon = 2.85; lon <= 6.35; lon += 0.06)
                NODES.push({ id: 'n' + i++, lat, lon, zone: 'wal' });
        
        // MAP
        S.map = L.map('map', { center: [50.5, 4.5], zoom: 8, zoomControl: false, preferCanvas: true });
        L.control.zoom({ position: 'bottomright' }).addTo(S.map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(S.map);
        S.layers = { nodes: L.layerGroup().addTo(S.map), cellules: L.layerGroup().addTo(S.map), links: L.layerGroup().addTo(S.map), zones: L.layerGroup() };
        
        function renderMap() {
            Object.values(S.layers).forEach(l => l.clearLayers());
            const taken = new Set(S.data.cellules.map(c => `${c.lat.toFixed(2)}_${c.lon.toFixed(2)}`));
            
            NODES.forEach(n => {
                if (taken.has(`${n.lat.toFixed(2)}_${n.lon.toFixed(2)}`)) return;
                const color = n.zone === 'bxl' ? '#003b7a' : '#aa1111';
                L.circleMarker([n.lat, n.lon], { radius: 3, color, fillColor: color, fillOpacity: 0.25, weight: 1 })
                    .on('click', () => selectNode(n)).addTo(S.layers.nodes);
            });
            
            S.data.cellules.forEach(c => {
                const ready = c.participants.length >= (c.min || 5);
                const atelier = S.data.ateliers.find(a => a.celluleId === c.id && a.status !== 'completed');
                let color = '#ffea00'; if (ready) color = '#00ff9d'; if (atelier) color = '#00d4ff';
                const size = 7 + c.participants.length * 1.5;
                L.circleMarker([c.lat, c.lon], { radius: size, color, fillColor: color, fillOpacity: 0.85, weight: 2 })
                    .on('click', () => showDetail(c.id))
                    .bindTooltip(`<b>${c.title}</b><br>${c.participants.length} participants`)
                    .addTo(S.layers.cellules);
                if (S.showZones && c.radius) L.circle([c.lat, c.lon], { radius: c.radius * 1000, color, fillOpacity: 0.06, weight: 1 }).addTo(S.layers.zones);
            });
            
            if (S.showLinks) {
                const ready = S.data.cellules.filter(c => c.participants.length >= 5);
                ready.forEach((a, i) => ready.slice(i + 1).forEach(b => {
                    const d = dist(a.lat, a.lon, b.lat, b.lon);
                    if (d <= 25) L.polyline([[a.lat, a.lon], [b.lat, b.lon]], { color: '#00d4ff', weight: Math.max(1, 2.5 - d / 12), opacity: Math.max(0.15, 0.5 - d / 50), dashArray: '6,10' }).addTo(S.layers.links);
                }));
            }
        }
        
        const dist = (lat1, lon1, lat2, lon2) => { const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); };
        const emoji = t => ({mobilite:'üö≤',environnement:'üå±',social:'ü§ù',numerique:'üíª',culture:'üé≠',economie:'üíº',democratie:'üó≥Ô∏è',education:'üìö',sante:'üè•'})[t]||'üìã';
        const toast = (m, e) => { const el=document.getElementById('toast'); el.textContent=m; el.classList.toggle('error',!!e); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000); };
        const showPanel = id => { document.querySelectorAll('.sidebar-panel').forEach(p=>p.classList.remove('active')); document.getElementById('panel-'+id).classList.add('active'); document.querySelectorAll('.sidebar-tab').forEach(t=>t.classList.toggle('active',t.dataset.panel===id)); };
        const updateStats = () => { document.getElementById('stat-c').textContent=S.data.cellules.length; document.getElementById('stat-p').textContent=S.data.cellules.reduce((s,c)=>s+c.participants.length,0); document.getElementById('stat-a').textContent=S.data.ateliers.filter(a=>a.status!=='completed').length; };
        
        // PANELS
        function renderList() {
            let html = `<button class="btn btn-primary btn-block" onclick="showCreatePanel()" style="margin-bottom:1rem;">+ Cr√©er une cellule</button>`;
            [...S.data.cellules].sort((a,b)=>b.participants.length-a.participants.length).forEach(c => {
                const ready = c.participants.length >= (c.min||5), atelier = S.data.ateliers.find(a=>a.celluleId===c.id&&a.status!=='completed');
                let badge='badge-yellow',status='Recrutement'; if(ready){badge='badge-green';status='Active';} if(atelier){badge='badge-blue';status='Atelier';}
                html += `<div class="card" onclick="showDetail('${c.id}')"><div class="card-header"><div class="card-title">${c.title}</div><span class="badge ${badge}">${status}</span></div><div class="card-meta">${emoji(c.theme)} ${c.theme} ‚Ä¢ ${c.participants.length}/${c.max||9}</div><div class="progress"><div class="progress-fill" style="width:${(c.participants.length/(c.max||9))*100}%"></div></div></div>`;
            });
            document.getElementById('panel-list').innerHTML = html;
        }
        
        function renderAteliers() {
            const active = S.data.ateliers.filter(a=>a.status!=='completed'), done = S.data.ateliers.filter(a=>a.status==='completed');
            let html = '';
            if (active.length) { html += '<div class="section-title">üî¥ EN COURS</div>'; active.forEach(a => { const c=S.data.cellules.find(x=>x.id===a.celluleId); html += `<div class="card" onclick="showDetail('${a.celluleId}')"><div class="card-header"><div class="card-title">${a.title}</div><span class="badge badge-blue">${a.status==='live'?'Live':'Async'}</span></div><div class="card-meta">${c?.title||''}</div></div>`; }); }
            if (done.length) { html += '<div class="section-title" style="margin-top:1rem;">‚úÖ TERMIN√âS</div>'; done.forEach(a => { const c=S.data.cellules.find(x=>x.id===a.celluleId); html += `<div class="card" onclick="showDetail('${a.celluleId}')"><div class="card-title">${a.title}</div><div class="card-meta">${c?.title||''} ‚Ä¢ ${a.outcomes?.length||0} d√©cisions</div></div>`; }); }
            document.getElementById('panel-ateliers').innerHTML = html || '<div style="text-align:center;padding:2rem;color:#444;">Aucun atelier</div>';
        }
        
        function renderSync() {
            document.getElementById('panel-sync').innerHTML = `
                <div class="section"><div class="section-title">üì§ EXPORTER</div><div class="btn-group" style="flex-direction:column;"><button class="btn btn-primary btn-block" onclick="exportJSON()">üì¶ T√©l√©charger</button><button class="btn btn-secondary btn-block" onclick="copyJSON()">üìã Copier</button></div></div>
                <div class="section"><div class="section-title">üì• IMPORTER</div><textarea class="form-input" id="import-text" placeholder="Collez JSON..." style="min-height:80px;font-size:0.6rem;"></textarea><button class="btn btn-primary btn-block" style="margin-top:0.5rem;" onclick="importJSON()">Fusionner</button></div>
                <div class="section"><div class="section-title">üîÑ RESET</div><button class="btn btn-danger btn-block" onclick="if(confirm('Reset ?')){localStorage.removeItem('${KEY}');location.reload();}">Donn√©es d√©mo</button></div>`;
        }
        
        window.showDetail = function(id) {
            const c = S.data.cellules.find(x=>x.id===id); if(!c) return;
            S.selected = c; S.map.setView([c.lat,c.lon],12); document.querySelector('.sidebar').classList.add('open');
            const ready = c.participants.length >= (c.min||5), atelier = S.data.ateliers.find(a=>a.celluleId===c.id), pct = (c.participants.length/(c.max||9))*100;
            
            let html = `<button class="btn btn-ghost btn-block" onclick="backToList()" style="margin-bottom:1rem;">‚Üê Retour</button>
                <div class="section"><div style="display:flex;justify-content:space-between;"><div class="card-title" style="font-size:1rem;">${c.title}</div>${ready?'<span class="badge badge-green">Active</span>':'<span class="badge badge-yellow">Recrutement</span>'}</div><div class="card-meta">${emoji(c.theme)} ${c.theme}</div><p style="font-size:0.75rem;color:#888;margin:0.75rem 0;">${c.desc||''}</p></div>
                <div class="section"><div class="section-title">üë• PARTICIPANTS (${c.participants.length}/${c.max||9})</div><div class="progress"><div class="progress-fill" style="width:${pct}%"></div></div><div style="margin-top:0.5rem;">${c.participants.map((p,i)=>`<div class="participant"><span style="color:${i===0?'var(--green)':'#888'}">${i===0?'üëë ':''}${p.name}</span>${i>0?`<button class="btn btn-danger" style="padding:0.15rem 0.3rem;font-size:0.5rem;" onclick="removeP('${c.id}',${i})">√ó</button>`:''}</div>`).join('')}</div>${c.participants.length<(c.max||9)?`<button class="btn btn-secondary btn-block" style="margin-top:0.5rem;" onclick="joinC('${c.id}')">+ Rejoindre</button>`:''}</div>`;
            
            if (ready || atelier) {
                html += `<div class="section"><div class="section-title">üìã ATELIER</div>`;
                if (atelier) {
                    html += `<div class="timeline"><div class="timeline-item"><div class="timeline-dot ${atelier.status!=='planned'?'done':''}"></div><div><div class="timeline-title">Async (14j)</div><div class="timeline-date">${atelier.asyncStart} ‚Üí ${atelier.asyncEnd}</div></div></div><div class="timeline-item"><div class="timeline-dot ${atelier.status==='live'?'active':atelier.status==='completed'?'done':''}"></div><div><div class="timeline-title">Live 48h</div><div class="timeline-date">${atelier.liveStart||''}</div></div></div></div>`;
                    if (atelier.contributions?.length) { html += '<div class="section-title" style="margin-top:0.5rem;">üí¨ CONTRIBUTIONS</div>'; atelier.contributions.slice(0,3).forEach(x => { html += `<div class="contribution"><div class="contribution-header"><span class="contribution-author">${x.author}</span><span class="contribution-votes">üëç ${x.votes||0}</span></div><div class="contribution-text">${x.text}</div></div>`; }); }
                    if (atelier.outcomes?.length) { html += '<div class="section-title" style="margin-top:0.5rem;">‚úÖ D√âCISIONS</div>'; atelier.outcomes.forEach(o => { html += `<div style="font-size:0.7rem;color:#ccc;padding:0.25rem 0;border-bottom:1px solid #222;">‚Ä¢ ${o}</div>`; }); }
                } else { html += `<div style="text-align:center;padding:1rem;"><div style="color:var(--green);margin-bottom:0.5rem;">‚úì Quorum atteint !</div><button class="btn btn-primary" onclick="startA('${c.id}')">üöÄ Lancer</button></div>`; }
                html += '</div>';
            }
            
            const matches = S.data.cellules.filter(x=>x.id!==c.id&&x.participants.length>=5).map(x=>({c:x,d:dist(c.lat,c.lon,x.lat,x.lon),score:Math.min(100,Math.round(50+Math.max(0,30-x.d*2)+(x.theme===c.theme?20:0)))})).filter(x=>x.d<=30).sort((a,b)=>b.score-a.score).slice(0,3);
            if (matches.length) { html += '<div class="section"><div class="section-title">üîó MATCHES</div>'; matches.forEach(m => { html += `<div class="match" onclick="showDetail('${m.c.id}')"><div><div style="font-size:0.75rem;color:var(--green);">${m.c.title}</div><div style="font-size:0.6rem;color:#666;">${m.d.toFixed(1)} km</div></div><div class="match-score">${m.score}%</div></div>`; }); html += '</div>'; }
            
            document.getElementById('panel-detail').innerHTML = html; showPanel('detail');
        };
        
        window.backToList = function() { S.selected=null; showPanel('list'); };
        
        function selectNode(n) { S.selectedNode=n; showCreatePanel(); S.map.setView([n.lat,n.lon],12); }
        
        window.showCreatePanel = function() {
            const loc = S.selectedNode ? `${S.selectedNode.lat.toFixed(4)}, ${S.selectedNode.lon.toFixed(4)}` : 'Cliquez sur la carte';
            document.getElementById('panel-create').innerHTML = `
                <button class="btn btn-ghost btn-block" onclick="backToList()" style="margin-bottom:1rem;">‚Üê Annuler</button>
                <div class="section"><div class="section-title">üìç POSITION</div><div style="color:${S.selectedNode?'var(--green)':'#666'};font-size:0.8rem;">${loc}</div></div>
                <div class="form-group"><label class="form-label">Pseudo *</label><input class="form-input" id="f-pseudo"></div>
                <div class="form-group"><label class="form-label">Titre *</label><input class="form-input" id="f-title"></div>
                <div class="form-group"><label class="form-label">Th√©matique *</label><select class="form-input" id="f-theme"><option value="">Choisir...</option><option value="mobilite">üö≤ Mobilit√©</option><option value="environnement">üå± Environnement</option><option value="social">ü§ù Social</option><option value="numerique">üíª Num√©rique</option><option value="culture">üé≠ Culture</option><option value="economie">üíº √âconomie</option><option value="democratie">üó≥Ô∏è D√©mocratie</option><option value="education">üìö √âducation</option><option value="sante">üè• Sant√©</option></select></div>
                <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="f-desc"></textarea></div>
                <button class="btn btn-primary btn-block" onclick="createC()">Cr√©er</button>`;
            showPanel('create'); document.querySelector('.sidebar').classList.add('open');
        };
        
        window.createC = function() {
            const pseudo=document.getElementById('f-pseudo').value.trim(), title=document.getElementById('f-title').value.trim(), theme=document.getElementById('f-theme').value, desc=document.getElementById('f-desc').value.trim();
            if (!pseudo||!title||!theme) { toast('Champs obligatoires',true); return; }
            if (!S.selectedNode) { toast('S√©lectionnez un point',true); return; }
            const c = { id:genId(), title, theme, desc, lat:S.selectedNode.lat, lon:S.selectedNode.lon, zone:S.selectedNode.zone, radius:5, min:5, max:9, creator:pseudo, participants:[{name:pseudo,role:'creator'}] };
            S.data.cellules.push(c); save(); S.selectedNode=null; renderMap(); renderList(); updateStats(); showDetail(c.id); toast('Cellule cr√©√©e !');
        };
        
        window.joinC = function(id) { const name=prompt('Pseudo :'); if(!name) return; const c=S.data.cellules.find(x=>x.id===id); if(!c||c.participants.some(p=>p.name.toLowerCase()===name.toLowerCase())) { toast('Pseudo pris',true); return; } c.participants.push({name}); save(); renderMap(); updateStats(); showDetail(id); toast(c.participants.length>=(c.min||5)?'üéâ Quorum !':'Bienvenue !'); };
        window.removeP = function(id,i) { const c=S.data.cellules.find(x=>x.id===id); if(!c||i===0) return; c.participants.splice(i,1); save(); renderMap(); updateStats(); showDetail(id); toast('Retir√©'); };
        window.startA = function(id) { const now=new Date(), end=new Date(now.getTime()+14*24*60*60*1000); S.data.ateliers.push({ id:'a'+Date.now(), celluleId:id, title:'Atelier '+now.toLocaleDateString('fr'), status:'async', asyncStart:now.toISOString().split('T')[0], asyncEnd:end.toISOString().split('T')[0], liveStart:end.toISOString().split('T')[0], contributions:[] }); save(); renderMap(); renderAteliers(); updateStats(); showDetail(id); toast('üöÄ Lanc√© !'); };
        
        window.exportJSON = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(S.data,null,2)],{type:'application/json'})); a.download=`cellules_${Date.now()}.json`; a.click(); toast('Export√© !'); };
        window.copyJSON = () => { navigator.clipboard.writeText(JSON.stringify(S.data,null,2)).then(()=>toast('Copi√© !')); };
        window.importJSON = () => { try { const d=JSON.parse(document.getElementById('import-text').value); let n=0; (d.cellules||[]).forEach(c=>{if(!S.data.cellules.some(x=>x.id===c.id)){S.data.cellules.push(c);n++;}}); (d.ateliers||[]).forEach(a=>{if(!S.data.ateliers.some(x=>x.id===a.id))S.data.ateliers.push(a);}); save(); renderMap(); renderList(); renderAteliers(); updateStats(); toast(`${n} import√©e(s) !`); } catch(e) { toast('JSON invalide',true); } };
        
        // EVENTS
        document.querySelectorAll('.sidebar-tab').forEach(t => t.addEventListener('click', function() { const p=this.dataset.panel; showPanel(p); if(p==='list')renderList(); if(p==='ateliers')renderAteliers(); if(p==='sync')renderSync(); }));
        document.getElementById('btn-links').addEventListener('click', function() { S.showLinks=!S.showLinks; this.classList.toggle('active',S.showLinks); renderMap(); });
        document.getElementById('btn-zones').addEventListener('click', function() { S.showZones=!S.showZones; this.classList.toggle('active',S.showZones); if(S.showZones)S.layers.zones.addTo(S.map); else S.map.removeLayer(S.layers.zones); renderMap(); });
        document.getElementById('btn-locate').addEventListener('click', () => navigator.geolocation?.getCurrentPosition(p=>S.map.setView([p.coords.latitude,p.coords.longitude],12)));
        
        // INIT
        renderMap(); renderList(); renderAteliers(); renderSync(); updateStats();
    })();
    </script>
</body>
</html>
